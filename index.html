<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SST Learning Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #4f46e5;
            --primary-light: #6366f1;
            --primary-dark: #4338ca;
            --secondary-color: #10b981;
            --warning-color: #f59e0b;
            
            /* Light Theme */
            --background-start: #e0e7ff;
            --background-end: #f3f4f6;
            --card-background: rgba(255, 255, 255, 0.6);
            --card-background-opaque: #ffffff;
            --text-color: #111827;
            --muted-text-color: #4b5563;
            --border-color: rgba(209, 213, 219, 0.7);
            --header-bg: rgba(249, 250, 251, 0.7);
            --nav-bg: rgba(249, 250, 251, 0.7);
            --nav-hover-bg: rgba(243, 244, 246, 0.8);
            --nav-active-bg: rgba(238, 242, 255, 0.9);
            --error-color: #ef4444;
            --success-color: #22c55e;
        }

        .dark {
            --background-start: #111827;
            --background-end: #1f2937;
            --card-background: rgba(31, 41, 55, 0.5);
            --card-background-opaque: #1f2937;
            --text-color: #f9fafb;
            --muted-text-color: #9ca3af;
            --border-color: rgba(75, 85, 99, 0.7);
            --header-bg: rgba(17, 24, 39, 0.7);
            --nav-bg: rgba(17, 24, 39, 0.7);
            --nav-hover-bg: rgba(31, 41, 55, 0.8);
            --nav-active-bg: rgba(55, 65, 81, 0.9);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--background-start), var(--background-end));
            background-size: 200% 200%;
            animation: gradient-animation 15s ease infinite;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            transition: background-color 0.3s;
        }
        
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .hidden {
            display: none !important;
        }

        /* Page transitions */
        .page {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Auth Forms --- */
        .auth-card {
            background-color: var(--card-background-opaque);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 450px;
            width: 100%;
            margin: 2rem auto;
            border: 1px solid var(--border-color);
        }

        .auth-card h1 {
            text-align: center;
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .auth-card p {
            text-align: center;
            color: var(--muted-text-color);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: var(--card-background-opaque);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
        }

        .btn {
            width: 100%;
            padding: 0.875rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-image: linear-gradient(to right, var(--primary-light), var(--primary-color));
            color: white;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2);
        }

        .btn-primary:hover {
            background-image: linear-gradient(to right, var(--primary-color), var(--primary-dark));
            box-shadow: 0 7px 15px rgba(79, 70, 229, 0.3);
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(1px);
        }

        .switch-form {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--muted-text-color);
        }

        .switch-form a {
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
        }

        .switch-form a:hover {
            text-decoration: underline;
        }
        
        .credit {
            text-align: center;
            margin-top: 2rem;
            font-size: 0.875rem;
            color: var(--muted-text-color);
        }
        
        /* --- Feedback Message --- */
        #feedback-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transition: transform 0.4s ease-in-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        #feedback-message.show {
            transform: translateX(-50%) translateY(0);
        }
        
        #feedback-message.success { background-color: var(--success-color); }
        #feedback-message.error { background-color: var(--error-color); }
        #feedback-message.info { background-color: #374151; }

        /* --- Dashboard --- */
        .dashboard {
            background-color: var(--card-background);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--header-bg);
        }
        
        .dashboard-header h1 { font-size: 1.5rem; }
        .dashboard-header span { font-weight: 400; color: var(--muted-text-color); }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted-text-color);
            transition: all 0.2s;
        }
        .theme-toggle-btn:hover {
            background-color: var(--nav-hover-bg);
            color: var(--text-color);
        }
        .theme-toggle-btn svg { width: 20px; height: 20px; }
        .dark .moon-icon { display: none; }
        .dark .sun-icon { display: block; }
        .sun-icon { display: none; }

        .btn-logout {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .dashboard-body {
            display: flex;
        }

        .dashboard-nav {
            width: 240px;
            background-color: var(--nav-bg);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem 0;
            flex-shrink: 0;
        }

        .dashboard-nav .nav-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            text-align: left;
            padding: 1rem 2rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--muted-text-color);
            border-left: 3px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        
        .nav-btn .icon { width: 20px; height: 20px; stroke-width: 2; }
        .dashboard-nav .nav-btn:hover { background-color: var(--nav-hover-bg); color: var(--text-color); }
        .dashboard-nav .nav-btn.active {
            color: var(--primary-color);
            font-weight: 600;
            border-left-color: var(--primary-color);
            background-color: var(--nav-active-bg);
        }

        .dashboard-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
            max-height: calc(100vh - 120px);
        }

        .section-header { margin-bottom: 1.5rem; }
        .section-header h2 { font-size: 1.75rem; margin-bottom: 0.25rem; }
        .section-header p { color: var(--muted-text-color); }
        
        .points-counter {
            font-weight: 600;
            color: var(--primary-color);
            background-color: var(--nav-active-bg);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* --- Topic List & Tables --- */
        .subject-section { margin-bottom: 2.5rem; }
        .subject-section h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .topic-list, .leaderboard-list, .student-list, .chat-history-list { list-style: none; }
        .topic-item, .leaderboard-item, .student-item, .chat-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: transparent;
            border-radius: 8px;
            border: 1px solid transparent;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }
        .student-item, .chat-history-item { cursor: pointer; }
        .topic-item:hover, .leaderboard-item:hover, .student-item:hover, .chat-history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            background-color: var(--nav-hover-bg);
            border-color: var(--border-color);
        }
        
        .topic-name { font-weight: 600; }
        .topic-status { font-size: 0.875rem; font-weight: 500; padding: 0.25rem 0.75rem; border-radius: 999px; }
        .topic-status.active { color: #15803d; background-color: #dcfce7; }
        .topic-status.inactive { color: #991b1b; background-color: #fee2e2; }
        
        .btn-quiz, .btn-discuss, .btn-edit-questions {
            background-color: var(--primary-color);
            color: white;
            padding: 0.5rem 1.25rem;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            margin-left: 0.5rem;
        }
        .btn-quiz:hover, .btn-discuss:hover, .btn-edit-questions:hover { background-color: var(--primary-dark); }
        .btn-revision-quiz {
            width: auto;
            margin-bottom: 1.5rem;
        }

        .leaderboard-rank { font-weight: 700; min-width: 30px; }
        .leaderboard-name { flex-grow: 1; font-weight: 500; }
        .leaderboard-score, .student-score { font-weight: 700; color: var(--primary-color); }
        
        /* --- Quiz & CMS Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            animation: fadeIn 0.3s;
        }

        .modal-container {
            background-color: var(--card-background-opaque);
            width: 90%;
            max-width: 800px;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            border: 1px solid var(--border-color);
            animation: scaleIn 0.3s ease-out;
        }
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .modal-header h2 { font-size: 1.25rem; }
        #quiz-timer, #quiz-progress-text { font-weight: 600; color: var(--primary-color); }
        #quiz-progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        #quiz-progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }
        
        .modal-body { padding: 2rem; overflow-y: auto; }
        #question-text { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; }
        
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        .option-btn {
            display: block; width: 100%; text-align: left; padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px; background-color: transparent; font-size: 1rem;
            cursor: pointer; transition: all 0.2s; color: var(--text-color);
        }
        .option-btn:hover { border-color: var(--primary-color); background-color: var(--nav-hover-bg); }
        .option-btn.correct { background-color: #dcfce7; border-color: #22c55e; color: #15803d; font-weight: 600;}
        .dark .option-btn.correct { background-color: #166534; color: #dcfce7; }
        .option-btn.incorrect { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .dark .option-btn.incorrect { background-color: #991b1b; color: #fee2e2; }
        .option-btn.disabled { cursor: not-allowed; opacity: 0.7; }

        .modal-footer {
            padding: 1.5rem; border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-between;
        }
        
        #quiz-result { text-align: center; padding: 3rem 2rem; }
        #quiz-result h2 { font-size: 2rem; margin-bottom: 1rem; }
        #quiz-result p { font-size: 1.125rem; margin-bottom: 2rem; color: var(--muted-text-color); }

        /* --- Teacher Toggles --- */
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { display: none; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--muted-text-color); transition: .4s; border-radius: 28px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px;
            left: 4px; bottom: 4px; background-color: white;
            transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--secondary-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* --- Loader --- */
        .loader {
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin: 2rem auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .skeleton-loader { display: flex; flex-direction: column; gap: 1rem; }
        .skeleton { background-color: var(--border-color); border-radius: 8px; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
        .skeleton-header { width: 40%; height: 32px; margin-bottom: 1rem; }
        .skeleton-item { width: 100%; height: 60px; }
        
        /* --- Analytics Dashboard --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card {
            background-color: var(--nav-bg); padding: 1.5rem;
            border-radius: 8px; border: 1px solid var(--border-color);
        }
        .stat-card h4 { font-size: 0.875rem; color: var(--muted-text-color); text-transform: uppercase; margin-bottom: 0.5rem; }
        .stat-card .value { font-size: 2.25rem; font-weight: 700; color: var(--primary-color); }
        
        .chart-container {
            margin-bottom: 2rem; background-color: var(--nav-bg); padding: 1.5rem;
            border-radius: 8px; border: 1px solid var(--border-color); height: 350px;
        }
        
        .topic-analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .topic-analysis-list h4 { font-size: 1.125rem; margin-bottom: 1rem; }
        .topic-analysis-list ul { list-style: none; }
        .topic-analysis-list li {
            background-color: var(--nav-bg); padding: 0.75rem 1rem;
            border-radius: 6px; margin-bottom: 0.5rem; font-weight: 500;
        }
        .strong-topics h4 { color: #16a34a; } .weak-topics h4 { color: #dc2626; }
        .ai-analysis-card {
            margin-top: 2rem;
            background-color: var(--nav-bg);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .ai-analysis-card h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .ai-analysis-card p {
            line-height: 1.6;
            color: var(--muted-text-color);
        }
        .dark .ai-analysis-card p {
            color: var(--text-color);
        }

        /* --- Achievements/Badges --- */
        .badges-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; }
        .badge-card {
            background-color: var(--nav-bg); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 1.5rem 1rem; text-align: center;
            opacity: 0.5; filter: grayscale(80%); transition: all 0.3s;
        }
        .badge-card.unlocked {
            opacity: 1; filter: grayscale(0%); border-color: var(--warning-color);
            background-color: #fffbeb; transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.2);
        }
        .dark .badge-card.unlocked { background-color: #422006; }
        .badge-icon { font-size: 3rem; line-height: 1; margin-bottom: 0.75rem; color: var(--warning-color); }
        .badge-card h4 { font-size: 1rem; margin-bottom: 0.25rem; font-weight: 600; }
        .badge-card p { font-size: 0.875rem; color: var(--muted-text-color); }
        
        #badge-notification {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%) translateY(200%);
            background-color: #111827; color: white;
            padding: 1rem 1.5rem; border-radius: 12px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.2);
            text-align: center; z-index: 1001;
            transition: transform 0.5s ease-in-out;
        }
        #badge-notification.show { transform: translateX(-50%) translateY(0); }
        #badge-notification .badge-icon { font-size: 2rem; }
        #badge-notification h3 { margin: 0.5rem 0; }

        /* Discussion Boards */
        .thread-item {
            background-color: transparent; padding: 1.25rem;
            border: 1px solid var(--border-color); border-radius: 8px;
            margin-bottom: 1rem; cursor: pointer; transition: all 0.2s;
        }
        .thread-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            background-color: var(--nav-hover-bg);
        }
        .thread-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; }
        .thread-meta { font-size: 0.875rem; color: var(--muted-text-color); }
        
        .new-thread-form { margin-top: 2rem; }
        
        #discussion-thread-view .post-list { margin-top: 2rem; list-style: none; }
        .post-item { padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .post-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 0.5rem; color: var(--muted-text-color); font-size: 0.875rem;
        }
        .post-author { font-weight: 600; color: var(--text-color); }
        .post-content { line-height: 1.6; }
        .delete-btn {
            background: none; border: none; color: var(--error-color); cursor: pointer; font-size: 0.875rem;
            margin-left: 1rem;
        }
        
        textarea.form-control {
            width: 100%; padding: 0.75rem 1rem; border-radius: 8px;
            border: 1px solid var(--border-color); font-size: 1rem;
            font-family: 'Inter', sans-serif; min-height: 100px;
            resize: vertical; color: var(--text-color); background-color: var(--card-background-opaque);
        }
        .btn-secondary {
            background-color: var(--border-color); color: var(--text-color);
            box-shadow: 0 4px 6px rgba(0,0,0, 0.05);
        }
        .btn-secondary:hover { background-color: var(--muted-text-color); }

        /* CMS Styles */
        .cms-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .question-list { list-style: none; }
        .question-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .question-item p { margin: 0; font-weight: 500; }
        .question-item-actions { display: flex; gap: 0.5rem; }
        .btn-edit-q, .btn-delete-q {
            background: none; border: none; cursor: pointer; padding: 0.25rem;
        }
        .btn-edit-q { color: var(--primary-color); }
        .btn-delete-q { color: var(--error-color); }
        .btn-edit-q:hover, .btn-delete-q:hover { opacity: 0.7; }

        /* AI Assistant Styles */
        .ai-generated-question {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .ai-generated-question h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        .ai-generated-question ul {
            list-style-position: inside;
            padding-left: 0.5rem;
            margin-bottom: 1rem;
        }
         .ai-generated-question .correct-answer {
            font-weight: 600;
            color: var(--success-color);
        }
        .ai-generated-question button {
            width: auto;
            padding: 0.5rem 1rem;
        }

        /* Quiz Explanation */
        #explanation-container {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        #explain-answer-btn {
            width: auto;
            margin-bottom: 1rem;
        }
        .explanation-content {
            background-color: var(--nav-hover-bg);
            padding: 1rem;
            border-radius: 8px;
            line-height: 1.6;
        }

        /* AI Chat Styles */
        .ai-chat-layout { display: flex; height: 100%; }
        .chat-history-sidebar {
            width: 280px;
            flex-shrink: 0;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        .chat-history-list { list-style: none; overflow-y: auto; flex-grow: 1; }
        .chat-history-item {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-history-item.active { background-color: var(--nav-active-bg); color: var(--primary-color); }

        .chat-main { flex-grow: 1; display: flex; flex-direction: column; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        .message-bubble {
            max-width: 75%;
            padding: 0.75rem 1.25rem;
            border-radius: 18px;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .message-bubble.user {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
            margin-left: auto;
        }
        .message-bubble.model {
            background-color: var(--nav-hover-bg);
            border-bottom-left-radius: 4px;
        }
        .chat-input-form {
            display: flex;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }
        #chat-input { flex-grow: 1; margin: 0; }
        #chat-submit-btn { width: auto; margin-left: 1rem; }

        @media (max-width: 1024px) {
            .dashboard-body { flex-direction: column; }
            .dashboard-sidebar {
                width: 100%; border-right: none; border-bottom: 2px solid var(--border-color);
                padding: 1rem; flex-direction: row; align-items: center;
            }
            .sidebar-header { margin-bottom: 0; flex-grow: 1; }
            .sidebar-nav { display: flex; gap: 0.5rem; flex-grow: 0;}
            .sidebar-nav .nav-btn span { display: none; } /* Hide text on small screens */
            .sidebar-footer { flex-direction: row; }
            .grid-cols-3 { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .grid-cols-3 { grid-template-columns: 1fr; }
            .dashboard-header { flex-direction: column; align-items: flex-start; gap: 1rem;}
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Page -->
        <div id="login-page" class="page">
            <div class="auth-card">
                <h1>Welcome Back!</h1>
                <p>Log in to continue your learning journey.</p>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-username">Username</label>
                        <input type="text" id="login-username" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Log In</button>
                </form>
                <p class="switch-form">Don't have an account? <a id="show-signup">Sign Up</a></p>
                <p class="credit">Made By - Akshaj Anand</p>
            </div>
        </div>

        <!-- Signup Page -->
        <div id="signup-page" class="page hidden">
            <div class="auth-card">
                <h1>Create Account</h1>
                <p>Start your social science adventure today!</p>
                <form id="signup-form">
                    <div class="form-group">
                        <label for="signup-username">Username</label>
                        <input type="text" id="signup-username" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <input type="password" id="signup-password" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary">Sign Up</button>
                </form>
                <p class="switch-form">Already have an account? <a id="show-login">Log In</a></p>
                <p class="credit">Made By - Akshaj Anand</p>
            </div>
        </div>

        <!-- Student Dashboard -->
        <div id="student-dashboard-page" class="page hidden">
            <div class="dashboard">
                <header class="dashboard-header">
                    <h1>Student Dashboard <span id="student-username"></span></h1>
                    <div class="header-controls">
                        <div class="points-counter">🏆 Total Points: <span id="student-total-points">0</span></div>
                        <button class="theme-toggle-btn" title="Toggle Theme">
                            <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
                            <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                        </button>
                        <button class="btn-logout">Logout</button>
                    </div>
                </header>
                <div class="dashboard-body">
                    <nav class="dashboard-nav">
                        <button class="nav-btn active" data-tab="student-topics">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v11.494m-5.747-6.99H17.75" /></svg>
                            Topics
                        </button>
                         <button class="nav-btn" data-tab="student-ai-assistant">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 002.25-2.25V6.75a2.25 2.25 0 00-2.25-2.25H6.75A2.25 2.25 0 004.5 6.75v10.5a2.25 2.25 0 002.25 2.25zm.75-12h9v9h-9v-9z" /></svg>
                            AI Assistant
                        </button>
                        <button class="nav-btn" data-tab="student-analysis">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            My Analysis
                        </button>
                        <button class="nav-btn" data-tab="student-leaderboard">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" /></svg>
                            Leaderboard
                        </button>
                        <button class="nav-btn" data-tab="student-badges">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Achievements
                        </button>
                    </nav>
                    <main class="dashboard-content">
                        <div id="student-topics" class="content-section"></div>
                        <div id="student-ai-assistant" class="content-section hidden" style="padding: 0; height: 100%;"></div>
                        <div id="student-analysis" class="content-section hidden"></div>
                        <div id="student-leaderboard" class="content-section hidden"></div>
                        <div id="student-badges" class="content-section hidden"></div>
                    </main>
                </div>
            </div>
        </div>

        <!-- Teacher Dashboard -->
        <div id="teacher-dashboard-page" class="page hidden">
            <div class="dashboard">
                <header class="dashboard-header">
                    <h1>Teacher Dashboard <span id="teacher-username"></span></h1>
                     <div class="header-controls">
                        <button class="theme-toggle-btn" title="Toggle Theme">
                            <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
                            <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                        </button>
                        <button class="btn-logout">Logout</button>
                    </div>
                </header>
                <div class="dashboard-body">
                    <nav class="dashboard-nav">
                        <button class="nav-btn active" data-tab="teacher-topics">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v11.494m-5.747-6.99H17.75" /></svg>
                            Manage Topics
                        </button>
                        <button class="nav-btn" data-tab="teacher-cms">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                            Content Management
                        </button>
                         <button class="nav-btn" data-tab="teacher-student-chats">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193l-3.72 3.72a1.125 1.125 0 01-1.59 0l-3.72-3.72A2.25 2.25 0 013.75 14.886V10.608c0-.97.616-1.813 1.5-2.097m14.25-1.125a2.25 2.25 0 00-2.25-2.25h-10.5a2.25 2.25 0 00-2.25 2.25v.458c.72-.121 1.453-.121 2.175 0V6.75h10.5v.458c.722.121 1.453.121 2.175 0V7.386z" /></svg>
                            Student Chats
                        </button>
                        <button class="nav-btn" data-tab="teacher-analysis">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            Platform Analytics
                        </button>
                        <button class="nav-btn" data-tab="teacher-students">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                            All Students
                        </button>
                        <button class="nav-btn" data-tab="teacher-leaderboard">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" /></svg>
                            Leaderboard
                        </button>
                    </nav>
                    <main class="dashboard-content">
                        <div id="teacher-topics" class="content-section"></div>
                        <div id="teacher-cms" class="content-section hidden"></div>
                        <div id="teacher-student-chats" class="content-section hidden" style="padding: 0; height: 100%;"></div>
                        <div id="teacher-analysis" class="content-section hidden"></div>
                        <div id="teacher-students" class="content-section hidden">
                             <div id="teacher-student-list-view"></div>
                             <div id="teacher-student-detail-view" class="hidden"></div>
                        </div>
                        <div id="teacher-leaderboard" class="content-section hidden"></div>
                    </main>
                </div>
            </div>
        </div>
        
        <!-- Discussion Board View -->
        <div id="discussion-board-page" class="page hidden">
             <div class="dashboard">
                <header class="dashboard-header">
                    <h1 id="discussion-topic-title">Discussion</h1>
                    <button class="btn btn-secondary" id="back-to-topics-btn">Back to Topics</button>
                </header>
                 <main class="dashboard-content">
                     <div id="discussion-thread-list"></div>
                     <div id="discussion-thread-view" class="hidden"></div>
                </main>
            </div>
        </div>

    </div>

    <!-- Quiz Modal -->
    <div id="quiz-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-header-top">
                    <h2 id="quiz-topic-name">Quiz</h2>
                    <div id="quiz-progress-text">Q: 1/30</div>
                    <div id="quiz-timer">Time: 15:00</div>
                </div>
                <div id="quiz-progress-bar-container">
                    <div id="quiz-progress-bar"></div>
                </div>
            </div>
            <div id="quiz-body" class="modal-body">
                <p id="question-text">Question text will appear here.</p>
                <div class="options-grid" id="options-container"></div>
                 <div id="explanation-container" class="hidden">
                    <button id="explain-answer-btn" class="btn btn-secondary" style="width:auto; margin-bottom: 1rem;">Explain Answer</button>
                    <div id="explanation-content" class="explanation-content"></div>
                </div>
            </div>
            <div id="quiz-footer" class="modal-footer">
                <button id="close-quiz-btn" class="btn btn-secondary">Close</button>
                <button id="next-question-btn" class="btn btn-primary">Next</button>
            </div>
            <div id="quiz-result" class="hidden"></div>
        </div>
    </div>
    
    <!-- Question CMS Modal -->
    <div id="question-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="question-modal-title">Add New Question</h2>
            </div>
            <div class="modal-body">
                <form id="question-form">
                    <input type="hidden" id="question-id">
                    <input type="hidden" id="question-topic-id">
                    <div class="form-group">
                        <label for="question-form-text">Question Text</label>
                        <textarea id="question-form-text" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="question-form-option-a">Option A</label>
                        <input type="text" id="question-form-option-a" required>
                    </div>
                    <div class="form-group">
                        <label for="question-form-option-b">Option B</label>
                        <input type="text" id="question-form-option-b" required>
                    </div>
                    <div class="form-group">
                        <label for="question-form-option-c">Option C</label>
                        <input type="text" id="question-form-option-c" required>
                    </div>
                    <div class="form-group">
                        <label for="question-form-option-d">Option D</label>
                        <input type="text" id="question-form-option-d" required>
                    </div>
                    <div class="form-group">
                        <label for="question-form-correct">Correct Answer</label>
                        <select id="question-form-correct" required>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="close-question-modal-btn" type="button" class="btn btn-secondary">Cancel</button>
                <button id="save-question-btn" type="submit" form="question-form" class="btn btn-primary">Save Question</button>
            </div>
        </div>
    </div>
    
    <!-- Topic CMS Modal -->
    <div id="topic-modal" class="modal-overlay hidden">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Add New Topic</h2>
            </div>
            <div class="modal-body">
                <form id="topic-form">
                    <div class="form-group">
                        <label for="topic-form-name">Topic Name</label>
                        <input type="text" id="topic-form-name" required>
                    </div>
                    <div class="form-group">
                        <label for="topic-form-subject">Subject</label>
                        <select id="topic-form-subject" required>
                            <option value="History">History</option>
                            <option value="Civics">Civics</option>
                            <option value="Geography">Geography</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="close-topic-modal-btn" type="button" class="btn btn-secondary">Cancel</button>
                <button id="save-topic-btn" type="submit" form="topic-form" class="btn btn-primary">Save Topic</button>
            </div>
        </div>
    </div>

    <!-- AI Assistant Modal -->
    <div id="ai-assistant-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header">
                <h2>AI Question Generator</h2>
            </div>
            <div class="modal-body">
                <form id="ai-generation-form" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; margin-bottom: 1.5rem;">
                    <div class="form-group" style="flex: 1 1 150px; margin:0;">
                        <label for="ai-num-questions">Number of questions:</label>
                        <input type="number" id="ai-num-questions" value="5" min="1" max="10">
                    </div>
                    <div class="form-group" style="flex: 2 1 300px; margin:0;">
                        <label for="ai-extra-prompt">Additional Instructions (Optional)</label>
                        <input type="text" id="ai-extra-prompt" placeholder="e.g., 'Focus on dates'">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: auto; flex: 1 1 auto;">Generate</button>
                </form>
                <div id="ai-results-container">
                    <p>Click "Generate" to create new questions for this topic.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="close-ai-modal-btn" type="button" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Badge Notification -->
    <div id="badge-notification">
        <div id="badge-notification-icon" class="badge-icon"></div>
        <h3>New Badge Unlocked!</h3>
        <p id="badge-notification-name"></p>
    </div>

    <div id="feedback-message"></div>
    
    <script>
    // --- SUPABASE & APP CONFIG --- //
    const SUPABASE_URL = 'https://cqxlqgiepqzogyrbpppo.supabase.co';
    const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxeGxxZ2llcHF6b2d5cmJwcHBvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzA2MzI0OSwiZXhwIjoyMDcyNjM5MjQ5fQ.sfwCz1T3TH8uJWTWG8WqfRhc20VjVNbKrGJFqVShHu4';

    if (SUPABASE_URL.includes('PASTE_YOUR') || SUPABASE_SERVICE_KEY.includes('PASTE_YOUR')) {
        document.body.innerHTML = `<div style="padding: 20px; text-align: center; font-family: sans-serif; background-color: #ffebee; border: 2px solid #c62828;">
            <h1>Configuration Needed!</h1>
            <p>Please paste your Supabase URL and Service Role Key into the script tag in this HTML file to connect to your database.</p>
        </div>`;
        throw new Error("Supabase credentials not configured.");
    }

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
    
    const TEACHER_ACCOUNTS = { 'akshajanand': 'teacher@123', 'kuhusinha': 'teacher@123' };
    let currentUser = null, quizState = {}, currentTimer = null, myChart = null;
    let quizLoading = false;
    let activeChatId = null;

    // --- UTILITY & PAGE NAVIGATION --- //
    function showFeedback(message, type = 'info', duration = 3000) {
        const feedbackEl = document.getElementById('feedback-message');
        feedbackEl.textContent = message;
        feedbackEl.className = type;
        feedbackEl.classList.add('show');
        setTimeout(() => { feedbackEl.classList.remove('show'); }, duration);
    }

    function showLoader(container, type = 'spinner') {
        if (type === 'list') {
            container.innerHTML = `<div class="skeleton-loader"><div class="skeleton skeleton-header"></div><div class="skeleton skeleton-item"></div><div class="skeleton skeleton-item"></div><div class="skeleton skeleton-item"></div></div>`;
        } else {
             container.innerHTML = '<div class="loader"></div>';
        }
    }

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
    }

    function showStudentDashboard() {
        document.getElementById('student-username').textContent = `(${currentUser.username})`;
        showPage('student-dashboard-page');
        updateStudentPointsDisplay();
        loadStudentTopics();
        switchDashboardTab(document.querySelector('#student-dashboard-page .nav-btn[data-tab="student-topics"]'), '#student-dashboard-page');
    }

    function showTeacherDashboard() {
        document.getElementById('teacher-username').textContent = `(${currentUser.username})`;
        showPage('teacher-dashboard-page');
        loadTeacherTopics();
        switchDashboardTab(document.querySelector('#teacher-dashboard-page .nav-btn[data-tab="teacher-topics"]'), '#teacher-dashboard-page');
    }
    
    async function updateStudentPointsDisplay() {
        if (!currentUser || currentUser.role !== 'student') return;
        const pointsEl = document.getElementById('student-total-points');
        if (!pointsEl) return;

        const { data, error } = await supabaseClient
            .from('student_performance')
            .select('total_score')
            .eq('user_id', currentUser.id)
            .single();
        
        if (error) {
            console.error("Could not fetch student points", error);
            pointsEl.textContent = 'N/A';
        } else {
            pointsEl.textContent = data.total_score;
        }
    }

    // --- AUTHENTICATION --- //
    async function handleLogin(e) {
        e.preventDefault();
        showFeedback('Logging in...', 'info', 2000);
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;

        if (TEACHER_ACCOUNTS[username] && TEACHER_ACCOUNTS[username] === password) {
            currentUser = { username, role: 'teacher' };
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            showTeacherDashboard();
            return;
        }

        const { data, error } = await supabaseClient.from('users').select('*').eq('username', username).eq('password', password).single();
        if (error || !data) {
            showFeedback('Invalid username or password.', 'error');
        } else {
            currentUser = { id: data.id, username: data.username, role: 'student' };
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            showStudentDashboard();
        }
    }

    async function handleLogout() {
        currentUser = null;
        sessionStorage.removeItem('currentUser');
        showPage('login-page');
    }

    async function handleSignup(e) {
        e.preventDefault();
        const username = document.getElementById('signup-username').value.trim();
        const email = document.getElementById('signup-email').value.trim();
        const password = document.getElementById('signup-password').value;

        if (TEACHER_ACCOUNTS[username]) {
            showFeedback('This username is reserved. Please choose another.', 'error');
            return;
        }

        const { data: userData, error: userError } = await supabaseClient.from('users').insert([{ username, email, password }]).select().single();
        if (userError) {
            if (userError.code === '23505') { showFeedback('Username or email already exists.', 'error'); } 
            else { showFeedback('Could not create account.', 'error'); }
            return;
        }

        const { error: performanceError } = await supabaseClient.from('student_performance').insert([{ user_id: userData.id, total_score: 0 }]);
        if (performanceError) { showFeedback('Account created, but could not initialize performance record.', 'error'); } 
        else { showFeedback('Account created successfully! Please log in.', 'success'); }
        
        showPage('login-page');
        document.getElementById('signup-form').reset();
    }
    
    // --- DASHBOARD & DATA --- //
    function switchDashboardTab(activeButton, pageSelector) {
        const page = document.querySelector(pageSelector);
        page.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        activeButton.classList.add('active');
        page.querySelectorAll('.content-section').forEach(sec => sec.classList.add('hidden'));
        const tabId = activeButton.dataset.tab;
        page.querySelector(`#${tabId}`).classList.remove('hidden');
        switch(tabId) {
            case 'student-topics': loadStudentTopics(); break;
            case 'student-ai-assistant': loadAiAssistantView(); break;
            case 'student-analysis': loadStudentAnalysis(); break;
            case 'student-leaderboard': loadLeaderboard('#student-leaderboard'); break;
            case 'student-badges': loadStudentBadges(); break;
            case 'teacher-topics': loadTeacherTopics(); break;
            case 'teacher-cms': loadCMSView(); break;
            case 'teacher-student-chats': loadTeacherStudentChatsView(); break;
            case 'teacher-analysis': loadPlatformAnalysis(); break;
            case 'teacher-students': loadAllStudents(); break;
            case 'teacher-leaderboard': loadLeaderboard('#teacher-leaderboard'); break;
        }
    }
    
    async function getTopics() {
        const { data, error } = await supabaseClient.from('topics').select('*');
        if (error) { showFeedback('Could not fetch topics.', 'error'); return {}; }
        return data.reduce((acc, topic) => {
            if (!acc[topic.subject]) acc[topic.subject] = [];
            acc[topic.subject].push(topic);
            return acc;
        }, {});
    }

    async function loadStudentTopics() {
        const container = document.getElementById('student-topics');
        showLoader(container, 'list');
        const topicsBySubject = await getTopics();
        let html = `<div class="section-header"><h2>Topics</h2><p>Choose a topic to start a quiz or join a discussion.</p></div>`;
        for (const subject in topicsBySubject) {
            html += `<div class="subject-section"><h3>${subject}</h3><ul class="topic-list">`;
            topicsBySubject[subject].forEach(topic => {
                if(topic.active_status) {
                    html += `<li class="topic-item"><span class="topic-name">${topic.name}</span><div><button class="btn-quiz" data-topic-id="${topic.id}" data-topic-name="${topic.name}">Start Quiz</button><button class="btn-discuss" data-topic-id="${topic.id}" data-topic-name="${topic.name}">Discuss</button></div></li>`;
                }
            });
            html += `</ul></div>`;
        }
        container.innerHTML = html;
    }

    async function loadTeacherTopics() {
        const container = document.getElementById('teacher-topics');
        showLoader(container, 'list');
        const topicsBySubject = await getTopics();
        let html = `<div class="section-header"><h2>Manage Topics</h2><p>Activate or deactivate topics for students.</p></div>`;
        for (const subject in topicsBySubject) {
            html += `<div class="subject-section"><h3>${subject}</h3><ul class="topic-list">`;
            topicsBySubject[subject].forEach(topic => {
                html += `<li class="topic-item"><span class="topic-name">${topic.name}</span><label class="switch"><input type="checkbox" class="topic-toggle" data-topic-id="${topic.id}" ${topic.active_status ? 'checked' : ''}><span class="slider"></span></label></li>`;
            });
            html += `</ul></div>`;
        }
        container.innerHTML = html;
    }

    async function loadLeaderboard(containerSelector) {
        const container = document.querySelector(containerSelector);
        showLoader(container, 'list');
        const { data, error } = await supabaseClient.from('student_performance').select('total_score, users(username)').order('total_score', { ascending: false }).limit(10);
        if (error) { container.innerHTML = `<p>Could not load leaderboard.</p>`; return; }
        let html = `<div class="section-header"><h2>Top Students</h2><p>See who's leading the charts!</p></div><ul class="leaderboard-list">`;
        data.forEach((entry, index) => {
            html += `<li class="leaderboard-item"><span class="leaderboard-rank">#${index + 1}</span><span class="leaderboard-name">${entry.users.username}</span><span class="leaderboard-score">${entry.total_score} pts</span></li>`;
        });
        html += `</ul>`;
        container.innerHTML = html;
    }

    async function loadAllStudents() {
        const container = document.getElementById('teacher-student-list-view');
        const detailContainer = document.getElementById('teacher-student-detail-view');
        container.classList.remove('hidden');
        detailContainer.classList.add('hidden');
        detailContainer.innerHTML = '';
        showLoader(container, 'list');
        const { data, error } = await supabaseClient.from('student_performance').select('total_score, users(id, username)');
        if (error) { container.innerHTML = `<p>Could not load student list.</p>`; return; }
        let html = `<div class="section-header"><h2>All Students</h2><p>Click on a student to view their detailed performance.</p></div><ul class="student-list">`;
        data.forEach(entry => {
            html += `<li class="student-item" data-student-id="${entry.users.id}" data-student-name="${entry.users.username}"><span class="student-name">${entry.users.username}</span><span class="student-score">${entry.total_score} pts</span></li>`;
        });
        html += `</ul>`;
        container.innerHTML = html;
    }

    // --- QUIZ LOGIC --- //
    async function initializeQuiz(questions, quizTitle) {
        document.getElementById('quiz-topic-name').textContent = quizTitle;
        document.getElementById('quiz-modal').classList.remove('hidden');
        document.getElementById('quiz-result').classList.add('hidden');
        document.getElementById('quiz-body').classList.remove('hidden');
        document.getElementById('quiz-footer').style.display = 'flex';
        document.getElementById('quiz-progress-bar').style.width = '0%';

        const shuffledQuestions = questions.sort(() => 0.5 - Math.random());
        quizState = {
            id: Date.now(), // Unique ID for this quiz session
            questions: shuffledQuestions.slice(0, 30),
            currentQuestionIndex: 0,
            score: 0,
            attempts: []
        };
        
        renderQuestion();
        startTimer(15 * 60);
        quizLoading = false;
    }
    
    async function startQuiz(topicId, topicName) {
        if (quizLoading) return;
        quizLoading = true;
        
        const quizId = Date.now();
        quizState.id = quizId;

        document.getElementById('question-text').textContent = 'Loading questions...';
        document.getElementById('options-container').innerHTML = '<div class="loader"></div>';

        const { data, error } = await supabaseClient.from('questions').select('*').eq('topic_id', topicId);
        
        if (quizState.id !== quizId) return; // A new quiz was started, abort this one.

        if (error || data.length === 0) {
            showFeedback('Could not load questions for this topic.', 'error');
            document.getElementById('quiz-modal').classList.add('hidden'); 
            quizLoading = false;
            return;
        }
        
        initializeQuiz(data, topicName);
    }
    
    async function startRevisionQuiz() {
        if (quizLoading) return;
        quizLoading = true;
        const quizId = Date.now();
        quizState.id = quizId;

        showFeedback("Building your personalized revision quiz...", 'info');
        
        const { data: incorrectAttempts, error } = await supabaseClient
            .from('attempts')
            .select('questions(*)')
            .eq('user_id', currentUser.id)
            .eq('score', 0);
        
        if (quizState.id !== quizId) return;

        if (error || !incorrectAttempts || incorrectAttempts.length < 1) {
            showFeedback("You don't have any incorrect answers to revise yet!", 'info');
            quizLoading = false;
            return;
        }

        const incorrectQuestions = [];
        const seenQuestionIds = new Set();
        for(const attempt of incorrectAttempts) {
            if (attempt.questions && !seenQuestionIds.has(attempt.questions.id)) {
                incorrectQuestions.push(attempt.questions);
                seenQuestionIds.add(attempt.questions.id);
            }
        }
        
        if (incorrectQuestions.length === 0) {
             showFeedback("You don't have any incorrect answers to revise yet!", 'info');
             quizLoading = false;
             return;
        }
        
        initializeQuiz(incorrectQuestions, "Personalized Revision Quiz");
    }

    function renderQuestion() {
        if (!quizState.questions || quizState.currentQuestionIndex >= quizState.questions.length) { endQuiz(); return; }
        document.getElementById('explanation-container').classList.add('hidden');
        document.getElementById('explanation-content').innerHTML = '';
        
        const question = quizState.questions[quizState.currentQuestionIndex];
        const progress = ((quizState.currentQuestionIndex) / quizState.questions.length) * 100;
        document.getElementById('quiz-progress-bar').style.width = `${progress}%`;
        document.getElementById('question-text').textContent = question.question_text || question.question;
        document.getElementById('quiz-progress-text').textContent = `Q: ${quizState.currentQuestionIndex + 1}/${quizState.questions.length}`;
        document.getElementById('options-container').innerHTML = `<button class="option-btn" data-option="A">${question.option_a}</button><button class="option-btn" data-option="B">${question.option_b}</button><button class="option-btn" data-option="C">${question.option_c}</button><button class="option-btn" data-option="D">${question.option_d}</button>`;
        document.getElementById('next-question-btn').classList.add('hidden');
    }

    function selectOption(selectedBtn) {
        const selectedOption = selectedBtn.dataset.option;
        quizState.lastAnswered = selectedOption;
        const question = quizState.questions[quizState.currentQuestionIndex];
        const isCorrect = selectedOption === question.correct_answer;
        let score = 0;
        if (isCorrect) { 
            quizState.score += 2; 
            score = 2; 
            selectedBtn.classList.add('correct'); 
        } else { 
            selectedBtn.classList.add('incorrect'); 
            document.querySelector(`.option-btn[data-option="${question.correct_answer}"]`)?.classList.add('correct'); 
        }
        quizState.attempts.push({ user_id: currentUser.id, question_id: question.id, selected_option: selectedOption, score: score });
        document.querySelectorAll('.option-btn').forEach(btn => btn.classList.add('disabled'));
        document.getElementById('explanation-container').classList.remove('hidden');
        document.getElementById('explain-answer-btn').disabled = false;
        document.getElementById('next-question-btn').classList.remove('hidden');
    }

    function nextQuestion() {
        quizState.currentQuestionIndex++;
        renderQuestion();
    }

    async function endQuiz() {
        clearInterval(currentTimer);
        document.getElementById('quiz-progress-bar').style.width = `100%`;
        
        if(quizState.attempts.length > 0) {
            const { error: attemptsError } = await supabaseClient.from('attempts').insert(quizState.attempts);
            if (attemptsError) { showFeedback('Error saving quiz results.', 'error'); }
        }

        const { data: performanceData, error: fetchError } = await supabaseClient
            .from('student_performance')
            .select('total_score')
            .eq('user_id', currentUser.id)
            .single();

        if (fetchError) {
            showFeedback('Error fetching current score.', 'error');
        } else {
            const newTotalScore = performanceData.total_score + quizState.score;
            const { error: updateError } = await supabaseClient
                .from('student_performance')
                .update({ total_score: newTotalScore })
                .eq('user_id', currentUser.id);

            if (updateError) {
                showFeedback('Error updating total score.', 'error');
            } else {
                await checkAndAwardBadges();
                await updateStudentPointsDisplay();
            }
        }

        document.getElementById('quiz-body').classList.add('hidden');
        document.getElementById('quiz-footer').style.display = 'none';
        const resultContainer = document.getElementById('quiz-result');
        resultContainer.classList.remove('hidden');
        resultContainer.innerHTML = `<h2>Quiz Complete!</h2><p>You scored ${quizState.score} out of ${quizState.questions.length * 2} points</p><button id="finish-quiz-btn" class="btn btn-primary">Finish</button>`;
    }

    function startTimer(duration) {
        let timer = duration;
        const timerEl = document.getElementById('quiz-timer');
        clearInterval(currentTimer);
        currentTimer = setInterval(() => {
            let minutes = parseInt(timer / 60, 10);
            let seconds = parseInt(timer % 60, 10);
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;
            timerEl.textContent = `Time: ${minutes}:${seconds}`;
            if (--timer < 0) { clearInterval(currentTimer); showFeedback('Time is up!', 'warning'); endQuiz(); }
        }, 1000);
    }
    
    // --- ANALYTICS DASHBOARD --- //
    function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            let currentValue = Math.floor(progress * (end - start) + start);
            obj.innerHTML = currentValue;
            if (progress < 1) { window.requestAnimationFrame(step); }
        };
        window.requestAnimationFrame(step);
    }

    async function loadStudentAnalysis(studentId = null, studentName = null) {
        const isTeacherView = !!(studentId && studentName);
        const targetUserId = isTeacherView ? studentId : currentUser.id;
        const container = isTeacherView ? document.getElementById('teacher-student-detail-view') : document.getElementById('student-analysis');
        
        showLoader(container);
        const { data: attempts, error } = await supabaseClient.from('attempts').select('score, questions(id, topics(name, subject))').eq('user_id', targetUserId);
        if (error || !attempts) { container.innerHTML = `<p>Could not load performance data.</p>`; return; }
        
        const backButton = isTeacherView ? `<button class="btn btn-secondary" style="width:auto; margin-bottom:1rem;" id="back-to-students-list">← Back to All Students</button>` : '';

        if (attempts.length === 0) {
            container.innerHTML = `${backButton}<div class="section-header"><h2>${isTeacherView ? studentName + "'s" : 'My'} Analysis</h2><p>No quiz data available yet.</p></div>`;
            return;
        }

        const totalQuestions = attempts.length;
        const correctAnswers = attempts.filter(a => a.score > 0).length;
        const incorrectAnswers = totalQuestions - correctAnswers;
        const overallAccuracy = totalQuestions > 0 ? ((correctAnswers / totalQuestions) * 100) : 0;
        
        const subjectPerf = attempts.reduce((acc, attempt) => {
            if (!attempt.questions || !attempt.questions.topics) return acc;
            const subject = attempt.questions.topics.subject;
            if (!acc[subject]) acc[subject] = { correct: 0, total: 0 };
            acc[subject].total++;
            if (attempt.score > 0) acc[subject].correct++;
            return acc;
        }, {});

        const topicPerf = attempts.reduce((acc, attempt) => {
            if (!attempt.questions || !attempt.questions.topics) return acc;
            const topic = attempt.questions.topics.name;
            if (!acc[topic]) acc[topic] = { correct: 0, total: 0 };
            acc[topic].total++;
            if (attempt.score > 0) acc[topic].correct++;
            return acc;
        }, {});
        
        const topicAccuracies = Object.entries(topicPerf).map(([topic, data]) => ({ name: topic, accuracy: (data.correct / data.total) * 100 })).sort((a, b) => b.accuracy - a.accuracy);
        const strongTopics = topicAccuracies.filter(t => t.accuracy >= 75).slice(0, 5);
        const weakTopics = topicAccuracies.filter(t => t.accuracy < 50).sort((a, b) => a.accuracy - b.accuracy).slice(0, 5);
        
        const revisionQuizButtonHtml = !isTeacherView && (incorrectAnswers >= 30 
            ? `<button class="btn btn-primary btn-revision-quiz">Create Revision Quiz</button>` 
            : `<button class="btn btn-secondary btn-revision-quiz" disabled title="Answer at least 30 questions incorrectly to unlock.">Create Revision Quiz</button>`);

        container.innerHTML = `
            ${backButton}
            <div class="section-header"><h2>${isTeacherView ? studentName + "'s" : 'My'} Analysis</h2><p>An overview of performance across all topics.</p></div>
            ${isTeacherView ? '' : revisionQuizButtonHtml}
            <div class="stats-grid" style="margin-top: 1.5rem;">
                <div class="stat-card"><h4>Overall Accuracy</h4><div class="value" data-value="${overallAccuracy.toFixed(1)}">0%</div></div>
                <div class="stat-card"><h4>Questions Answered</h4><div class="value" data-value="${totalQuestions}">0</div></div>
                <div class="stat-card"><h4>Correct Answers</h4><div class="value" data-value="${correctAnswers}">0</div></div>
                <div class="stat-card"><h4>Incorrect Answers</h4><div class="value" data-value="${incorrectAnswers}">0</div></div>
            </div>
            <div class="chart-container"><h3>Performance by Subject</h3><canvas id="${isTeacherView ? 'teacher-student-chart' : 'student-chart'}"></canvas></div>
            <div class="topic-analysis-grid">
                <div class="topic-analysis-list strong-topics"><h4>💪 Strong Topics</h4><ul>${strongTopics.map(t => `<li>${t.name}</li>`).join('') || '<li>Complete more quizzes!</li>'}</ul></div>
                <div class="topic-analysis-list weak-topics"><h4>🧠 Topics to Revise</h4><ul>${weakTopics.map(t => `<li>${t.name}</li>`).join('') || '<li>Looking good!</li>'}</ul></div>
            </div>
            <div class="ai-analysis-card">
                <h3>✨ ${isTeacherView ? 'AI Performance Summary' : 'AI Tutor Insights'}</h3>
                <div id="ai-student-analysis-content"><div class="loader"></div></div>
            </div>
        `;
        
        container.querySelectorAll('.stat-card .value').forEach(el => {
            const isPercent = el.textContent.includes('%');
            const endValue = parseFloat(el.dataset.value);
            animateValue(el, 0, endValue, 1500);
            if(isPercent) el.innerHTML = endValue.toFixed(1) + "%";
        });
        
        const ctx = document.getElementById(isTeacherView ? 'teacher-student-chart' : 'student-chart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(subjectPerf),
                datasets: [{
                    label: 'Accuracy (%)',
                    data: Object.values(subjectPerf).map(s => (s.correct / s.total * 100).toFixed(1)),
                    backgroundColor: ['#4f46e5', '#10b981', '#f59e0b'],
                    borderRadius: 5
                }]
            },
            options: { scales: { y: { beginAtZero: true, max: 100 } }, responsive: true, maintainAspectRatio: false }
        });

        getAiStudentAnalysis({ overallAccuracy, strongTopics, weakTopics, isTeacherView, studentName });
    }

    async function loadPlatformAnalysis() {
        const container = document.getElementById('teacher-analysis');
        showLoader(container);
        const { data: attempts, error } = await supabaseClient.from('attempts').select('score, questions(topics(name, subject))');
        if (error || attempts.length === 0) { container.innerHTML = `<p>No student attempt data available yet.</p>`; return; }

        const totalAttempts = attempts.length;
        const totalCorrect = attempts.filter(a => a.score > 0).length;
        const avgAccuracy = (totalCorrect / totalAttempts * 100);
        const { count: studentCount } = await supabaseClient.from('users').select('*', { count: 'exact', head: true });
        
        const topicPerf = attempts.reduce((acc, attempt) => {
            if (!attempt.questions || !attempt.questions.topics) return acc;
            const topic = attempt.questions.topics.name;
            if (!acc[topic]) acc[topic] = { correct: 0, total: 0 };
            acc[topic].total++;
            if (attempt.score > 0) acc[topic].correct++;
            return acc;
        }, {});

        const topicAccuracies = Object.entries(topicPerf).map(([topic, data]) => ({ name: topic, accuracy: (data.correct / data.total) * 100 }));
        const mostDifficultTopics = topicAccuracies.sort((a,b) => a.accuracy - b.accuracy).slice(0, 5);

        container.innerHTML = `
            <div class="section-header"><h2>Platform Analytics</h2><p>A high-level overview of student performance.</p></div>
            <div class="stats-grid">
                <div class="stat-card"><h4>Total Students</h4><div class="value" data-value="${studentCount || 0}">0</div></div>
                <div class="stat-card"><h4>Total Attempts</h4><div class="value" data-value="${totalAttempts}">0</div></div>
                <div class="stat-card"><h4>Average Accuracy</h4><div class="value" data-value="${avgAccuracy.toFixed(1)}">0%</div></div>
            </div>
            <div class="topic-analysis-grid"><div class="topic-analysis-list weak-topics"><h4>Most Difficult Topics (Lowest Accuracy)</h4><ul>${mostDifficultTopics.map(t => `<li>${t.name} (${t.accuracy.toFixed(1)}%)</li>`).join('')}</ul></div></div>
             <div id="ai-platform-analysis" class="ai-analysis-card">
                <h3>✨ AI Analyst Summary</h3>
                <div id="ai-platform-analysis-content"><div class="loader"></div></div>
            </div>
        `;
        
        container.querySelectorAll('.stat-card .value').forEach(el => {
            const isPercent = el.textContent.includes('%');
            const endValue = parseFloat(el.dataset.value);
            animateValue(el, 0, endValue, 1500);
            if(isPercent) el.innerHTML = endValue.toFixed(1) + "%";
        });
        
        getAiPlatformAnalysis({ avgAccuracy, studentCount, mostDifficultTopics });
    }

    // --- ACHIEVEMENTS / BADGES --- //
    async function loadStudentBadges() {
        const container = document.getElementById('student-badges');
        showLoader(container);
        const { data: allBadges, error: badgesError } = await supabaseClient.from('badges').select('*');
        const { data: studentBadges, error: studentBadgesError } = await supabaseClient.from('student_badges').select('badge_id').eq('user_id', currentUser.id);
        if (badgesError || studentBadgesError) { container.innerHTML = `<p>Could not load achievements.</p>`; return; }
        const unlockedBadgeIds = new Set(studentBadges.map(b => b.badge_id));
        let html = `<div class="section-header"><h2>My Achievements</h2><p>Collect badges by reaching milestones on your learning journey!</p></div><div class="badges-grid">`;
        allBadges.sort((a,b) => a.id - b.id).forEach(badge => {
            html += `<div class="badge-card ${unlockedBadgeIds.has(badge.id) ? 'unlocked' : ''}"><div class="badge-icon">${badge.icon}</div><h4>${badge.name}</h4><p>${badge.description}</p></div>`;
        });
        html += `</div>`;
        container.innerHTML = html;
    }

    async function checkAndAwardBadges() {
        const { data: allBadges } = await supabaseClient.from('badges').select('*');
        const { data: studentBadges } = await supabaseClient.from('student_badges').select('badge_id').eq('user_id', currentUser.id);
        const unlockedBadgeIds = new Set(studentBadges.map(b => b.badge_id));
        const newBadgesToAward = [];
        const { data: perfData } = await supabaseClient.from('student_performance').select('total_score').eq('user_id', currentUser.id).single();
        const totalScore = perfData.total_score;
        const { count: attemptsCount } = await supabaseClient.from('attempts').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id);
        
        for (const badge of allBadges) {
            if (unlockedBadgeIds.has(badge.id)) continue;
            let conditionMet = false;
            switch(badge.condition_type) {
                case 'total_score': if(totalScore >= badge.condition_value) conditionMet = true; break;
                case 'quizzes_completed': if(attemptsCount / 30 >= badge.condition_value) conditionMet = true; break;
            }
            if(conditionMet) {
                newBadgesToAward.push({ user_id: currentUser.id, badge_id: badge.id });
                showBadgeNotification(badge);
            }
        }
        if (newBadgesToAward.length > 0) {
            await supabaseClient.from('student_badges').insert(newBadgesToAward);
        }
    }

    function showBadgeNotification(badge) {
        const notification = document.getElementById('badge-notification');
        document.getElementById('badge-notification-icon').textContent = badge.icon;
        document.getElementById('badge-notification-name').textContent = badge.name;
        notification.classList.add('show');
        setTimeout(() => { notification.classList.remove('show'); }, 5000);
    }
    
    // --- DISCUSSION BOARDS --- //
    async function showDiscussionBoard(topicId, topicName) {
        showPage('discussion-board-page');
        document.getElementById('discussion-topic-title').textContent = `Discussions for: ${topicName}`;
        document.getElementById('discussion-thread-view').classList.add('hidden');
        const listContainer = document.getElementById('discussion-thread-list');
        listContainer.classList.remove('hidden');
        showLoader(listContainer, 'list');

        const { data: threads, error } = await supabaseClient.from('discussion_threads').select('*, users(username)').eq('topic_id', topicId).order('created_at', { ascending: false });
        if (error) { listContainer.innerHTML = `<p>Could not load discussions.</p>`; return; }

        let html = `<div class="section-header"><h2>Threads</h2><p>Start a new conversation or join an existing one.</p></div><ul class="threads-list">`;
        threads.forEach(thread => {
            const author = thread.users ? thread.users.username : 'Teacher';
            html += `<li class="thread-item" data-thread-id="${thread.id}"><h4 class="thread-title">${thread.title}</h4><p class="thread-meta">Started by ${author} on ${new Date(thread.created_at).toLocaleDateString()}</p></li>`;
        });
        html += `</ul>
            <form id="new-thread-form" class="new-thread-form">
                <div class="section-header"><h4>Start a New Thread</h4></div>
                <div class="form-group"><input type="text" id="new-thread-title" class="form-group input" placeholder="Thread Title" required style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); color: var(--text-color); background-color: var(--card-background-opaque);"/></div>
                <div class="form-group"><textarea id="new-thread-content" class="form-control" placeholder="Your question or comment..." required></textarea></div>
                <button type="submit" class="btn btn-primary">Post Thread</button>
            </form>
        `;
        listContainer.innerHTML = html;

        document.getElementById('new-thread-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('new-thread-title').value;
            const content = document.getElementById('new-thread-content').value;
            const authorId = currentUser.role === 'student' ? currentUser.id : null;

            const { data: threadData, error: threadError } = await supabaseClient.from('discussion_threads').insert({ topic_id: topicId, title, author_id: authorId }).select().single();
            if (threadError) { showFeedback('Could not create thread.', 'error'); return; }
            const { error: postError } = await supabaseClient.from('discussion_posts').insert({ thread_id: threadData.id, content, author_id: authorId, author_name: currentUser.username });
            if (postError) { showFeedback('Could not create initial post.', 'error'); } else {
                showFeedback('Thread created!', 'success');
                showDiscussionBoard(topicId, topicName);
            }
        });
    }

    async function showThreadView(threadId) {
        document.getElementById('discussion-thread-list').classList.add('hidden');
        const viewContainer = document.getElementById('discussion-thread-view');
        viewContainer.classList.remove('hidden');
        showLoader(viewContainer);
        
        const { data: thread } = await supabaseClient.from('discussion_threads').select('*').eq('id', threadId).single();
        const { data: posts } = await supabaseClient.from('discussion_posts').select('*').eq('thread_id', threadId).order('created_at');
        
        let html = `<div class="section-header"><h2 data-thread-id="${thread.id}">${thread.title}</h2></div><ul class="post-list">`;
        posts.forEach(post => {
            const deleteButton = currentUser.role === 'teacher' ? `<button class="delete-btn" data-post-id="${post.id}">Delete</button>` : '';
            html += `<li class="post-item"><div class="post-header"><span class="post-author">${post.author_name}</span><div><span class="post-date">${new Date(post.created_at).toLocaleString()}</span>${deleteButton}</div></div><p class="post-content">${post.content.replace(/\n/g, '<br>')}</p></li>`;
        });
        html += `</ul>
            <form id="new-post-form" class="new-post-form">
                <div class="section-header"><h4>Post a Reply</h4></div>
                <div class="form-group"><textarea id="new-post-content" class="form-control" placeholder="Your reply..." required></textarea></div>
                <button type="submit" class="btn btn-primary">Post Reply</button>
            </form>
        `;
        viewContainer.innerHTML = html;
        
        document.getElementById('new-post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = document.getElementById('new-post-content').value;
            const authorId = currentUser.role === 'student' ? currentUser.id : null;
            const { error } = await supabaseClient.from('discussion_posts').insert({ thread_id: threadId, content, author_id: authorId, author_name: currentUser.username });
            if (error) { showFeedback('Could not post reply.', 'error'); } else { showThreadView(threadId); }
        });
    }
    
    async function deleteDiscussionPost(postId) {
        if(currentUser.role !== 'teacher') return;
        const currentThreadId = document.querySelector('[data-thread-id]').dataset.threadId;
        const { error } = await supabaseClient.from('discussion_posts').delete().eq('id', postId);
        if (error) { showFeedback('Could not delete post.', 'error'); } else {
            showFeedback('Post deleted.', 'success');
            showThreadView(currentThreadId);
        }
    }
    
    // --- CMS (TEACHER ONLY) --- //
    async function loadCMSView() {
        const container = document.getElementById('teacher-cms');
        showLoader(container, 'list');
        const topicsBySubject = await getTopics();
        let html = `<div id="cms-topic-list">
            <div class="section-header cms-header">
                <div>
                    <h2>Content Management</h2>
                    <p>Select a topic to add, edit, or delete questions.</p>
                </div>
                <button class="btn btn-primary" style="width: auto;" id="add-topic-btn">Add New Topic</button>
            </div>
        `;
        for (const subject in topicsBySubject) {
            html += `<div class="subject-section"><h3>${subject}</h3><ul class="topic-list">`;
            topicsBySubject[subject].forEach(topic => {
                html += `<li class="topic-item"><span class="topic-name">${topic.name}</span><div><button class="btn-edit-questions" data-topic-id="${topic.id}" data-topic-name="${topic.name}">Manage Questions</button></div></li>`;
            });
            html += `</ul></div>`;
        }
        html += '</div><div id="cms-question-editor" class="hidden"></div>'
        container.innerHTML = html;
    }

    async function loadQuestionEditor(topicId, topicName) {
        document.getElementById('cms-topic-list').classList.add('hidden');
        const editorContainer = document.getElementById('cms-question-editor');
        editorContainer.classList.remove('hidden');
        showLoader(editorContainer);
        
        const { data: questions, error } = await supabaseClient.from('questions').select('*').eq('topic_id', topicId).order('id');
        if (error) { editorContainer.innerHTML = '<p>Could not load questions.</p>'; return; }

        let html = `
            <div class="section-header">
                <button class="btn btn-secondary" style="width: auto; float: left; margin-right: 1rem;" id="back-to-cms-topics">← Back</button>
                <h2>Editing: ${topicName}</h2>
                <p>Manage the questions for this topic.</p>
            </div>
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <button class="btn btn-primary btn-add-question" style="width: auto;" data-topic-id="${topicId}">Add New Question</button>
                <button class="btn btn-secondary btn-ai-generate" style="width: auto;" data-topic-id="${topicId}" data-topic-name="${topicName}">Generate with AI</button>
            </div>
            <ul class="question-list">
        `;
        questions.forEach(q => {
            const questionText = q.question_text || q.question;
            html += `
                <li class="question-item" data-question-id="${q.id}">
                    <p>${questionText.substring(0, 100)}${questionText.length > 100 ? '...' : ''}</p>
                    <div class="question-item-actions">
                        <button class="btn-edit-q" title="Edit Question">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg>
                        </button>
                        <button class="btn-delete-q" title="Delete Question">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                        </button>
                    </div>
                </li>
            `;
        });
        html += `</ul>`;
        editorContainer.innerHTML = html;
    }
    
    function openQuestionModal(questionData = null) {
        const modal = document.getElementById('question-modal');
        const form = document.getElementById('question-form');
        form.reset();
        if (questionData) {
            document.getElementById('question-modal-title').textContent = 'Edit Question';
            document.getElementById('question-id').value = questionData.id;
            document.getElementById('question-topic-id').value = questionData.topic_id;
            document.getElementById('question-form-text').value = questionData.question_text || questionData.question;
            document.getElementById('question-form-option-a').value = questionData.option_a;
            document.getElementById('question-form-option-b').value = questionData.option_b;
            document.getElementById('question-form-option-c').value = questionData.option_c;
            document.getElementById('question-form-option-d').value = questionData.option_d;
            document.getElementById('question-form-correct').value = questionData.correct_answer;
        } else {
            document.getElementById('question-modal-title').textContent = 'Add New Question';
        }
        modal.classList.remove('hidden');
    }

    async function handleQuestionFormSubmit(e) {
        e.preventDefault();
        const questionId = document.getElementById('question-id').value;
        const topicId = document.getElementById('question-topic-id').value;
        const questionPayload = {
            topic_id: topicId,
            question_text: document.getElementById('question-form-text').value,
            option_a: document.getElementById('question-form-option-a').value,
            option_b: document.getElementById('question-form-option-b').value,
            option_c: document.getElementById('question-form-option-c').value,
            option_d: document.getElementById('question-form-option-d').value,
            correct_answer: document.getElementById('question-form-correct').value,
        };

        let error;
        if (questionId) {
            ({ error } = await supabaseClient.from('questions').update(questionPayload).eq('id', questionId));
        } else {
            ({ error } = await supabaseClient.from('questions').insert(questionPayload));
        }
        
        if (error) {
            showFeedback('Error saving question.', 'error');
            console.error(error);
        } else {
            showFeedback(`Question successfully ${questionId ? 'updated' : 'added'}!`, 'success');
            document.getElementById('question-modal').classList.add('hidden');
            const topicName = document.querySelector('#cms-question-editor .section-header h2').textContent.replace('Editing: ','');
            loadQuestionEditor(topicId, topicName);
        }
    }

    async function handleDeleteQuestion(questionId) {
        const { error } = await supabaseClient.from('questions').delete().eq('id', questionId);
        if (error) {
            showFeedback('Could not delete question.', 'error');
        } else {
            showFeedback('Question deleted.', 'success');
            const questionItem = document.querySelector(`.question-item[data-question-id="${questionId}"]`);
            if (questionItem) questionItem.remove();
        }
    }

    function openTopicModal() {
        document.getElementById('topic-modal').classList.remove('hidden');
        document.getElementById('topic-form').reset();
    }

    async function handleTopicFormSubmit(e) {
        e.preventDefault();
        const topicName = document.getElementById('topic-form-name').value;
        const subject = document.getElementById('topic-form-subject').value;

        if (!topicName || !subject) {
            showFeedback('Please fill out all fields.', 'error');
            return;
        }

        const { error } = await supabaseClient
            .from('topics')
            .insert({ name: topicName, subject: subject, active_status: true });

        if (error) {
            showFeedback('Could not create the new topic.', 'error');
            console.error(error);
        } else {
            showFeedback('New topic created successfully!', 'success');
            document.getElementById('topic-modal').classList.add('hidden');
            loadCMSView();
        }
    }

    // --- AI ASSISTANT (CHAT & GENERATION) --- //
    async function getGeminiApiKey() {
        const { data, error } = await supabaseClient
            .from('api_keys')
            .select('api_key')
            .eq('service_name', 'GEMINI')
            .single();
        if (error || !data || !data.api_key || data.api_key.includes('PASTE_YOUR')) {
            throw new Error("Gemini API key is not configured in the database 'api_keys' table.");
        }
        return data.api_key;
    }

    async function callGemini(userQuery, systemPrompt = null) {
        const apiKey = await getGeminiApiKey();
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
        };
        if (systemPrompt) {
            payload.systemInstruction = { parts: [{ text: systemPrompt }] };
        }
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) throw new Error("No content received from AI.");
        return text;
    }
    
    async function getAiStudentAnalysis(analysisData) {
        const contentEl = document.getElementById('ai-student-analysis-content');
        try {
            let prompt;
            if(analysisData.isTeacherView) {
                 prompt = `Act as an educational analyst. A teacher is viewing a student named ${analysisData.studentName}'s performance. The student has the following data: Overall Accuracy: ${analysisData.overallAccuracy.toFixed(1)}%. Strongest Topics: ${analysisData.strongTopics.map(t => t.name).join(', ') || 'None yet'}. Weakest Topics: ${analysisData.weakTopics.map(t => t.name).join(', ') || 'None yet'}. Based on this, provide a short (2-3 sentences) summary for the teacher, highlighting the student's main strengths and areas for improvement.`;
            } else {
                 prompt = `Act as a friendly and encouraging AI Tutor. The student has the following performance data in Social Science: Overall Accuracy: ${analysisData.overallAccuracy.toFixed(1)}%. Strongest Topics: ${analysisData.strongTopics.map(t => t.name).join(', ') || 'None yet'}. Weakest Topics: ${analysisData.weakTopics.map(t => t.name).join(', ') || 'None yet'}. Based on this, provide a short (2-3 sentences), personalized paragraph of feedback and suggest one specific area they should focus on next.`;
            }
            const analysisText = await callGemini(prompt);
            contentEl.innerHTML = `<p>${analysisText}</p>`;
        } catch (error) {
            contentEl.innerHTML = `<p>AI analysis could not be generated at this time.</p>`;
            console.error("AI Student Analysis Error:", error);
        }
    }

    async function getAiPlatformAnalysis(analysisData) {
         const contentEl = document.getElementById('ai-platform-analysis-content');
        try {
            const prompt = `Act as an educational data analyst. The learning platform has the following aggregate data: Total Students: ${analysisData.studentCount}. Average Quiz Accuracy: ${analysisData.avgAccuracy.toFixed(1)}%. The 5 most difficult topics for students are: ${analysisData.mostDifficultTopics.map(t => `${t.name} (${t.accuracy.toFixed(1)}%)`).join(', ')}. Provide a short (2-3 sentences) summary of the platform's health and suggest a potential area for instructional focus.`;
            const analysisText = await callGemini(prompt);
            contentEl.innerHTML = `<p>${analysisText}</p>`;
        } catch (error) {
            contentEl.innerHTML = `<p>AI analysis could not be generated at this time.</p>`;
            console.error("AI Platform Analysis Error:", error);
        }
    }

    function openAiAssistant(topicId, topicName) {
        const modal = document.getElementById('ai-assistant-modal');
        modal.dataset.topicId = topicId;
        modal.dataset.topicName = topicName;
        document.getElementById('ai-results-container').innerHTML = `<p>Click "Generate" to create new questions for the topic: <strong>${topicName}</strong>.</p>`;
        modal.classList.remove('hidden');
    }

    async function handleAiGenerationFormSubmit(e) {
        e.preventDefault();
        const numQuestions = document.getElementById('ai-num-questions').value;
        const topicName = document.getElementById('ai-assistant-modal').dataset.topicName;
        const resultsContainer = document.getElementById('ai-results-container');
        resultsContainer.innerHTML = '<div class="loader"></div><p>Generating questions... This may take a moment.</p>';
        const extraPrompt = document.getElementById('ai-extra-prompt').value.trim();

        try {
            const apiKey = await getGeminiApiKey();
            let userQuery = `Generate ${numQuestions} unique, high-quality multiple-choice questions for a Class 8 Social Science student on the topic "${topicName}". The questions should be factual and conceptual. Return the response as a valid JSON array of objects. Each object must have the following keys: "question_text", "option_a", "option_b", "option_c", "option_d", "correct_answer". The "correct_answer" key must have a value of "A", "B", "C", or "D".`;
            if (extraPrompt) {
                userQuery += ` \n\nAdditional instructions: ${extraPrompt}`;
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "question_text": { "type": "STRING" },
                                "option_a": { "type": "STRING" },
                                "option_b": { "type": "STRING" },
                                "option_c": { "type": "STRING" },
                                "option_d": { "type": "STRING" },
                                "correct_answer": { "type": "STRING" },
                            }
                        }
                    }
                },
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            
            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) throw new Error("No content received from AI.");

            const generatedQuestions = JSON.parse(jsonText);
            renderAiGeneratedQuestions(generatedQuestions);
        } catch (error) {
            resultsContainer.innerHTML = `<p style="color: var(--error-color)">Error generating questions: ${error.message}</p>`;
            console.error(error);
        }
    }

    function renderAiGeneratedQuestions(questions) {
        const resultsContainer = document.getElementById('ai-results-container');
        if (!questions || questions.length === 0) {
            resultsContainer.innerHTML = `<p>The AI could not generate questions for this topic. Please try again.</p>`;
            return;
        }
        
        let html = '';
        questions.forEach((q, index) => {
            const questionData = JSON.stringify(q).replace(/"/g, '&quot;');
            html += `
                <div class="ai-generated-question">
                    <h4>${index + 1}. ${q.question_text || q.question}</h4>
                    <ul>
                        <li>A: ${q.option_a}</li>
                        <li>B: ${q.option_b}</li>
                        <li>C: ${q.option_c}</li>
                        <li>D: ${q.option_d}</li>
                    </ul>
                    <p>Correct Answer: <span class="correct-answer">${q.correct_answer}</span></p>
                    <button class="btn btn-secondary btn-add-ai-q" data-question='${questionData}'>Add to Topic</button>
                </div>
            `;
        });
        resultsContainer.innerHTML = html;
    }

    async function handleAddAiQuestion(button) {
        const topicId = document.getElementById('ai-assistant-modal').dataset.topicId;
        const questionData = JSON.parse(button.dataset.question);
        
        const questionText = questionData.question_text || questionData.question;
        const optionA = questionData.option_a;
        const optionB = questionData.option_b;
        const optionC = questionData.option_c;
        const optionD = questionData.option_d;
        const correctAnswer = questionData.correct_answer;

        if (!questionText || !optionA || !optionB || !optionC || !optionD || !correctAnswer) {
            showFeedback('AI returned an incomplete question. Cannot add.', 'error');
            button.textContent = 'Invalid Data';
            button.disabled = true;
            console.error("Invalid AI question data received:", questionData);
            return;
        }

        const payload = {
            topic_id: topicId,
            question_text: questionText,
            option_a: optionA,
            option_b: optionB,
            option_c: optionC,
            option_d: optionD,
            correct_answer: correctAnswer
        };

        const { error } = await supabaseClient.from('questions').insert(payload);
        if (error) {
            showFeedback('Error adding this question to the database.', 'error');
            console.error("Supabase insert error:", error, "Payload:", payload);
        } else {
            showFeedback('Question added!', 'success');
            button.textContent = 'Added!';
            button.disabled = true;
        }
    }
    
    async function handleExplainAnswer() {
        const btn = document.getElementById('explain-answer-btn');
        btn.disabled = true;
        const contentEl = document.getElementById('explanation-content');
        contentEl.innerHTML = '<div class="loader"></div>';

        const question = quizState.questions[quizState.currentQuestionIndex];
        const userAnswer = quizState.lastAnswered;
        
        try {
            const prompt = `Act as a helpful Social Science tutor for a Class 8 student. The student was asked: "${question.question_text || question.question}". The options were A) ${question.option_a}, B) ${question.option_b}, C) ${question.option_c}, D) ${question.option_d}. The correct answer is ${question.correct_answer}. The student chose ${userAnswer}. Please provide a simple explanation in one or two short paragraphs. First, explain why the correct answer is right. Then, if the student's answer was wrong, briefly explain why their choice was incorrect.`;
            const explanationText = await callGemini(prompt);
            contentEl.innerHTML = `<p>${explanationText}</p>`;
        } catch (error) {
            contentEl.innerHTML = `<p>Could not generate an explanation at this time.</p>`;
            console.error("AI Explanation Error:", error);
        }
    }

    async function loadAiAssistantView() {
        const container = document.getElementById('student-ai-assistant');
        container.innerHTML = `
            <div class="ai-chat-layout">
                <div class="chat-history-sidebar">
                    <button class="btn btn-primary" id="new-chat-btn">New Chat</button>
                    <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">History</h3>
                    <ul class="chat-history-list" id="chat-history-list">
                        <div class="loader"></div>
                    </ul>
                </div>
                <div class="chat-main">
                    <div class="chat-messages" id="chat-messages">
                        <p style="text-align: center; color: var(--muted-text-color);">Select a conversation or start a new one.</p>
                    </div>
                    <form class="chat-input-form" id="chat-form">
                        <input type="text" id="chat-input" placeholder="Ask your SST question..." class="form-control" autocomplete="off" required>
                        <button type="submit" id="chat-submit-btn" class="btn btn-primary">Send</button>
                    </form>
                </div>
            </div>
        `;
        loadChatHistory();

        document.getElementById('new-chat-btn').addEventListener('click', () => {
            activeChatId = null;
            document.getElementById('chat-messages').innerHTML = `<p style="text-align: center; color: var(--muted-text-color);">Ask me anything about Social Science!</p>`;
            document.querySelectorAll('.chat-history-item').forEach(item => item.classList.remove('active'));
        });
        
        document.getElementById('chat-form').addEventListener('submit', handleChatMessageSubmit);
    }
    
    async function loadChatHistory(userId = null) {
        const listEl = document.getElementById('chat-history-list');
        const targetUserId = userId || currentUser.id;
        
        const { data, error } = await supabaseClient.from('ai_chats').select('*').eq('user_id', targetUserId).order('created_at', { ascending: false });

        if(error) {
            console.error("Error fetching chat history", error);
            listEl.innerHTML = `<p>Could not load history.</p>`;
            return;
        }

        if(data.length === 0) {
            listEl.innerHTML = `<p style="color: var(--muted-text-color); font-size: 0.875rem; text-align: center;">No chats yet.</p>`;
            return;
        }

        listEl.innerHTML = data.map(chat => `<li class="chat-history-item" data-chat-id="${chat.id}">${chat.title}</li>`).join('');
    }

    async function loadChatMessages(chatId, container, isTeacherView = false) {
        activeChatId = chatId;
        
        document.querySelectorAll('.chat-history-item').forEach(item => {
            item.classList.toggle('active', item.dataset.chatId === chatId);
        });
        
        container.innerHTML = '<div class="loader"></div>';
        
        const { data, error } = await supabaseClient.from('ai_chat_messages').select('*').eq('chat_id', chatId).order('created_at');

        if (error) {
            container.innerHTML = `<p>Error loading messages.</p>`;
            return;
        }
        
        container.innerHTML = data.map(msg => `<div class="message-bubble ${msg.role}">${msg.content.replace(/\n/g, '<br>')}</div>`).join('');
        container.scrollTop = container.scrollHeight;
        
        if (isTeacherView) {
            document.getElementById('chat-input').disabled = true;
            document.getElementById('chat-submit-btn').disabled = true;
        } else {
             document.getElementById('chat-input').disabled = false;
            document.getElementById('chat-submit-btn').disabled = false;
        }
    }

    async function handleChatMessageSubmit(e) {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        const userInput = input.value.trim();
        if(!userInput) return;

        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.innerHTML += `<div class="message-bubble user">${userInput}</div>`;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        input.value = '';
        
        const systemPrompt = "You are a helpful and friendly AI Tutor for a Class 8 student in India studying Social Science (History, Civics, Geography). Your goal is to explain concepts clearly and simply. Keep your answers concise and easy to understand. If a question is outside the scope of SST, politely decline to answer.";

        try {
            if (!activeChatId) {
                const title = userInput.substring(0, 30) + (userInput.length > 30 ? '...' : '');
                const { data, error } = await supabaseClient.from('ai_chats').insert({ user_id: currentUser.id, title: title }).select().single();
                if(error) throw error;
                activeChatId = data.id;
                await loadChatHistory();
                 document.querySelector(`.chat-history-item[data-chat-id="${activeChatId}"]`).classList.add('active');
            }

            await supabaseClient.from('ai_chat_messages').insert({ chat_id: activeChatId, role: 'user', content: userInput });
            
            const aiResponse = await callGemini(userInput, systemPrompt);

            await supabaseClient.from('ai_chat_messages').insert({ chat_id: activeChatId, role: 'model', content: aiResponse });

            messagesContainer.innerHTML += `<div class="message-bubble model">${aiResponse.replace(/\n/g, '<br>')}</div>`;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

        } catch (error) {
            showFeedback('Error communicating with AI Assistant.', 'error');
            console.error(error);
        }
    }

    async function loadTeacherStudentChatsView() {
        const container = document.getElementById('teacher-student-chats');
        container.innerHTML = `<div class="ai-chat-layout" id="teacher-chat-view"></div>`;
        const chatViewContainer = document.getElementById('teacher-chat-view');
        showLoader(chatViewContainer);

        const { data: students, error } = await supabaseClient.from('users').select('id, username');
        if (error || !students) {
            chatViewContainer.innerHTML = `<p>Could not load students.</p>`;
            return;
        }
        
        let selectOptions = students.map(s => `<option value="${s.id}">${s.username}</option>`).join('');
        
        chatViewContainer.innerHTML = `
            <div class="chat-history-sidebar">
                 <div class="form-group" style="margin:0;">
                    <label for="student-chat-select">Select a Student</label>
                    <select id="student-chat-select">
                        <option value="">-- Select --</option>
                        ${selectOptions}
                    </select>
                </div>
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Chat History</h3>
                <ul class="chat-history-list" id="chat-history-list">
                    <p style="color: var(--muted-text-color); font-size: 0.875rem; text-align: center;">Select a student to view their chats.</p>
                </ul>
            </div>
            <div class="chat-main">
                <div class="chat-messages" id="chat-messages">
                     <p style="text-align: center; color: var(--muted-text-color);">Select a student and then a conversation to view it.</p>
                </div>
                <form class="chat-input-form" id="chat-form">
                    <input type="text" id="chat-input" placeholder="Viewing student chat..." disabled>
                    <button type="submit" id="chat-submit-btn" class="btn btn-primary" disabled>Send</button>
                </form>
            </div>
        `;
        
        document.getElementById('student-chat-select').addEventListener('change', async (e) => {
            const studentId = e.target.value;
            if(studentId) {
                await loadChatHistory(studentId);
                 document.getElementById('chat-messages').innerHTML = `<p style="text-align: center; color: var(--muted-text-color);">Select a conversation from the list.</p>`;
            } else {
                 document.getElementById('chat-history-list').innerHTML = `<p style="color: var(--muted-text-color); font-size: 0.875rem; text-align: center;">Select a student to view their chats.</p>`;
                 document.getElementById('chat-messages').innerHTML = `<p style="text-align: center; color: var(--muted-text-color);">Select a student and then a conversation to view it.</p>`;
            }
        });
    }

    // --- THEME --- //
    function applyTheme(theme) {
        const isDark = theme === 'dark';
        document.documentElement.classList.toggle('dark', isDark);
    }

    function toggleTheme() {
        const isDark = document.documentElement.classList.contains('dark');
        const newTheme = isDark ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    }

    // --- EVENT LISTENERS --- //
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);

        document.getElementById('show-signup').addEventListener('click', () => { showPage('signup-page'); });
        document.getElementById('show-login').addEventListener('click', () => { showPage('login-page'); });
        
        document.querySelectorAll('.theme-toggle-btn').forEach(btn => {
            btn.addEventListener('click', toggleTheme);
        });

        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('signup-form').addEventListener('submit', handleSignup);
        document.getElementById('question-form').addEventListener('submit', handleQuestionFormSubmit);
        document.getElementById('topic-form').addEventListener('submit', handleTopicFormSubmit);
        document.getElementById('ai-generation-form').addEventListener('submit', handleAiGenerationFormSubmit);
        
        document.body.addEventListener('click', async (e) => {
            // General
            if (e.target.classList.contains('btn-logout')) handleLogout();
            if (e.target.closest('.nav-btn')) {
                const navBtn = e.target.closest('.nav-btn');
                const pageSelector = `#${navBtn.closest('.page').id}`;
                switchDashboardTab(navBtn, pageSelector);
            }
            // Quiz
            if (e.target.classList.contains('btn-quiz')) startQuiz(e.target.dataset.topicId, e.target.dataset.topicName);
            if (e.target.classList.contains('btn-revision-quiz')) startRevisionQuiz();
            if (e.target.id === 'close-quiz-btn' || e.target.id === 'finish-quiz-btn') { 
                document.getElementById('quiz-modal').classList.add('hidden'); 
                clearInterval(currentTimer);
                quizState = {};
                quizLoading = false;
            }
            if (e.target.classList.contains('option-btn') && !e.target.classList.contains('disabled')) selectOption(e.target);
            if (e.target.id === 'next-question-btn') nextQuestion();
            if (e.target.id === 'explain-answer-btn') handleExplainAnswer();
            // Discussions
            if (e.target.classList.contains('btn-discuss')) showDiscussionBoard(e.target.dataset.topicId, e.target.dataset.topicName);
            if (e.target.id === 'back-to-topics-btn') showStudentDashboard();
            if (e.target.closest('.thread-item')) showThreadView(e.target.closest('.thread-item').dataset.threadId);
            if (e.target.classList.contains('delete-btn')) deleteDiscussionPost(e.target.dataset.postId);
            // CMS
            if (e.target.classList.contains('btn-edit-questions')) loadQuestionEditor(e.target.dataset.topicId, e.target.dataset.topicName);
            if (e.target.id === 'back-to-cms-topics') loadCMSView();
            if (e.target.id === 'add-topic-btn') openTopicModal();
            if (e.target.id === 'close-topic-modal-btn') document.getElementById('topic-modal').classList.add('hidden');
            if (e.target.classList.contains('btn-add-question')) {
                const topicId = e.target.dataset.topicId;
                openQuestionModal();
                document.getElementById('question-topic-id').value = topicId;
            }
            if(e.target.closest('.btn-edit-q')) {
                const questionId = e.target.closest('.question-item').dataset.questionId;
                const { data } = await supabaseClient.from('questions').select('*').eq('id', questionId).single();
                if(data) openQuestionModal(data);
            }
             if(e.target.closest('.btn-delete-q')) {
                const questionId = e.target.closest('.question-item').dataset.questionId;
                handleDeleteQuestion(questionId);
            }
            if (e.target.id === 'close-question-modal-btn') document.getElementById('question-modal').classList.add('hidden');
            // AI Assistant
            if (e.target.classList.contains('btn-ai-generate')) openAiAssistant(e.target.dataset.topicId, e.target.dataset.topicName);
            if (e.target.id === 'close-ai-modal-btn') document.getElementById('ai-assistant-modal').classList.add('hidden');
            if (e.target.classList.contains('btn-add-ai-q')) handleAddAiQuestion(e.target);
            if(e.target.closest('.chat-history-item')) {
                const chatId = e.target.closest('.chat-history-item').dataset.chatId;
                const isTeacherView = !!document.getElementById('teacher-student-chats');
                loadChatMessages(chatId, document.getElementById('chat-messages'), isTeacherView);
            }
            // Teacher view of student performance
            if (e.target.closest('.student-item')) {
                const studentItem = e.target.closest('.student-item');
                const studentId = studentItem.dataset.studentId;
                const studentName = studentItem.dataset.studentName;
                document.getElementById('teacher-student-list-view').classList.add('hidden');
                const detailView = document.getElementById('teacher-student-detail-view');
                detailView.classList.remove('hidden');
                loadStudentAnalysis(studentId, studentName);
            }
            if (e.target.id === 'back-to-students-list') {
                loadAllStudents();
            }
        });
        
        document.body.addEventListener('change', async (e) => {
            if (e.target.classList.contains('topic-toggle')) {
                const { error } = await supabaseClient.from('topics').update({ active_status: e.target.checked }).eq('id', e.target.dataset.topicId);
                if (error) { showFeedback('Failed to update status.', 'error'); e.target.checked = !e.target.checked; } 
                else { showFeedback('Topic status updated!', 'success'); }
            }
        });
        
        const storedUser = sessionStorage.getItem('currentUser');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            if (currentUser.role === 'student') showStudentDashboard();
            else if (currentUser.role === 'teacher') showTeacherDashboard();
        } else {
            showPage('login-page');
        }
    })
    // Add this code at the end of your JavaScript to enable AI context referencing
// Replace the existing handleChatMessageSubmit function

async function handleChatMessageSubmit(e) {
    e.preventDefault();
    const input = document.getElementById('chat-input');
    const userInput = input.value.trim();
    if(!userInput) return;

    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.innerHTML += `<div class="message-bubble user">${userInput}</div>`;
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    input.value = '';
    
    const systemPrompt = "You are a helpful and friendly AI Tutor for a Class 8 student in India studying Social Science (History, Civics, Geography). Your goal is to explain concepts clearly and simply. Keep your answers concise and easy to understand. If a question is outside the scope of SST, politely decline to answer.";

    try {
        if (!activeChatId) {
            const title = userInput.substring(0, 30) + (userInput.length > 30 ? '...' : '');
            const { data, error } = await supabaseClient.from('ai_chats').insert({ user_id: currentUser.id, title: title }).select().single();
            if(error) throw error;
            activeChatId = data.id;
            await loadChatHistory();
             document.querySelector(`.chat-history-item[data-chat-id="${activeChatId}"]`).classList.add('active');
        }

        await supabaseClient.from('ai_chat_messages').insert({ chat_id: activeChatId, role: 'user', content: userInput });
        
        // Fetch previous messages for context
        const { data: previousMessages } = await supabaseClient
            .from('ai_chat_messages')
            .select('role, content')
            .eq('chat_id', activeChatId)
            .order('created_at', { ascending: false })
            .limit(8);
            
        let contextualPrompt = userInput;
        
        if (previousMessages && previousMessages.length > 1) {
            const contextMessages = previousMessages.reverse().slice(-6, -1);
            let conversationContext = "Previous conversation:\n";
            
            contextMessages.forEach(msg => {
                const speaker = msg.role === 'user' ? 'Student' : 'Tutor';
                conversationContext += `${speaker}: ${msg.content}\n`;
            });
            
            contextualPrompt = `${conversationContext}\nCurrent question: ${userInput}`;
        }
            
        const aiResponse = await callGemini(contextualPrompt, systemPrompt);

        await supabaseClient.from('ai_chat_messages').insert({ chat_id: activeChatId, role: 'model', content: aiResponse });

        messagesContainer.innerHTML += `<div class="message-bubble model">${aiResponse.replace(/\n/g, '<br>')}</div>`;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

    } catch (error) {
        showFeedback('Error communicating with AI Assistant.', 'error');
        console.error(error);
    }
}// Fix for chat history selection
document.addEventListener('click', function(e) {
    const chatHistoryItem = e.target.closest('.chat-history-item');
    if (chatHistoryItem && chatHistoryItem.dataset.chatId) {
        const chatId = chatHistoryItem.dataset.chatId;
        const messagesContainer = document.getElementById('chat-messages');
        const isTeacherView = !!document.getElementById('teacher-student-chats').querySelector('.ai-chat-layout');
        
        if (messagesContainer) {
            loadChatMessages(chatId, messagesContainer, isTeacherView);
        }
    }
})
// Replace the existing handleChatMessageSubmit function with this personalized version

async function handleChatMessageSubmit(e) {
    e.preventDefault();
    const input = document.getElementById('chat-input');
    const userInput = input.value.trim();
    if(!userInput) return;

    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.innerHTML += `<div class="message-bubble user">${userInput}</div>`;
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    input.value = '';
    
    // Get student's name for personalization
    const studentName = currentUser.username;
    
    const systemPrompt = `You are a helpful and friendly AI Tutor for a Class 8 student in India studying Social Science (History, Civics, Geography). The student's name is ${studentName}. Always address them by their name in your responses to make it personal and engaging. Your goal is to explain concepts clearly and simply. Keep your answers concise and easy to understand. If a question is outside the scope of SST, politely decline to answer while still using their name.`;

    try {
        if (!activeChatId) {
            const title = userInput.substring(0, 30) + (userInput.length > 30 ? '...' : '');
            const { data, error } = await supabaseClient.from('ai_chats').insert({ user_id: currentUser.id, title: title }).select().single();
            if(error) throw error;
            activeChatId = data.id;
            await loadChatHistory();
            document.querySelector(`.chat-history-item[data-chat-id="${activeChatId}"]`).classList.add('active');
        }

        await supabaseClient.from('ai_chat_messages').insert({ chat_id: activeChatId, role: 'user', content: userInput });
        
        // Fetch previous messages for context
        const { data: previousMessages } = await supabaseClient
            .from('ai_chat_messages')
            .select('role, content')
            .eq('chat_id', activeChatId)
            .order('created_at', { ascending: false })
            .limit(8);
            
        let contextualPrompt = userInput;
        
        if (previousMessages && previousMessages.length > 1) {
            const contextMessages = previousMessages.reverse().slice(-6, -1);
            let conversationContext = `Previous conversation with ${studentName}:\n`;
            
            contextMessages.forEach(msg => {
                const speaker = msg.role === 'user' ? studentName : 'Tutor';
                conversationContext += `${speaker}: ${msg.content}\n`;
            });
            
            contextualPrompt = `${conversationContext}\n${studentName}'s current question: ${userInput}\n\nPlease respond to ${studentName} while considering our previous conversation.`;
        } else {
            contextualPrompt = `${studentName} asks: ${userInput}`;
        }
            
        const aiResponse = await callGemini(contextualPrompt, systemPrompt);

        await supabaseClient.from('ai_chat_messages').insert({ chat_id: activeChatId, role: 'model', content: aiResponse });

        messagesContainer.innerHTML += `<div class="message-bubble model">${aiResponse.replace(/\n/g, '<br>')}</div>`;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

    } catch (error) {
        showFeedback('Error communicating with AI Assistant.', 'error');
        console.error(error);
    }
}// Replace the existing handleChatMessageSubmit function with this advanced learning version

async function handleChatMessageSubmit(e) {
    e.preventDefault();
    const input = document.getElementById('chat-input');
    const userInput = input.value.trim();
    if(!userInput) return;

    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.innerHTML += `<div class="message-bubble user">${userInput}</div>`;
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    input.value = '';
    
    const studentName = currentUser.username;

    try {
        if (!activeChatId) {
            const title = userInput.substring(0, 30) + (userInput.length > 30 ? '...' : '');
            const { data, error } = await supabaseClient.from('ai_chats').insert({ user_id: currentUser.id, title: title }).select().single();
            if(error) throw error;
            activeChatId = data.id;
            await loadChatHistory();
            document.querySelector(`.chat-history-item[data-chat-id="${activeChatId}"]`).classList.add('active');
        }

        await supabaseClient.from('ai_chat_messages').insert({ chat_id: activeChatId, role: 'user', content: userInput });
        
        // Fetch ALL previous messages from ALL chats for this student to build comprehensive understanding
        const { data: allStudentMessages } = await supabaseClient
            .from('ai_chat_messages')
            .select('role, content, created_at, ai_chats!inner(user_id)')
            .eq('ai_chats.user_id', currentUser.id)
            .order('created_at', { ascending: true });
            
        // Get student's quiz performance data for learning context
        const { data: studentPerformance } = await supabaseClient
            .from('attempts')
            .select('score, questions(topics(name, subject))')
            .eq('user_id', currentUser.id);
            
        // Build comprehensive student profile
        let studentProfile = `Student Profile for ${studentName}:\n`;
        
        if (studentPerformance && studentPerformance.length > 0) {
            const totalQuestions = studentPerformance.length;
            const correctAnswers = studentPerformance.filter(a => a.score > 0).length;
            const accuracy = ((correctAnswers / totalQuestions) * 100).toFixed(1);
            
            // Analyze subject-wise performance
            const subjectPerf = studentPerformance.reduce((acc, attempt) => {
                if (attempt.questions?.topics) {
                    const subject = attempt.questions.topics.subject;
                    if (!acc[subject]) acc[subject] = { correct: 0, total: 0 };
                    acc[subject].total++;
                    if (attempt.score > 0) acc[subject].correct++;
                }
                return acc;
            }, {});
            
            studentProfile += `- Overall quiz accuracy: ${accuracy}%\n`;
            studentProfile += `- Subjects studied: ${Object.keys(subjectPerf).join(', ')}\n`;
            
            Object.entries(subjectPerf).forEach(([subject, data]) => {
                const subjectAccuracy = ((data.correct / data.total) * 100).toFixed(1);
                studentProfile += `- ${subject} performance: ${subjectAccuracy}%\n`;
            });
        }
        
        // Build conversation history summary
        let conversationSummary = '';
        if (allStudentMessages && allStudentMessages.length > 0) {
            const recentMessages = allStudentMessages.slice(-20); // Last 20 messages for immediate context
            conversationSummary = `Recent conversation history with ${studentName}:\n`;
            
            recentMessages.forEach(msg => {
                const speaker = msg.role === 'user' ? studentName : 'Tutor';
                conversationSummary += `${speaker}: ${msg.content}\n`;
            });
            
            // Analyze conversation patterns for learning insights
            const userMessages = allStudentMessages.filter(m => m.role === 'user');
            if (userMessages.length > 5) {
                studentProfile += `- Has asked ${userMessages.length} questions in total\n`;
                
                // Find common topics/keywords in questions
                const allQuestions = userMessages.map(m => m.content.toLowerCase()).join(' ');
                const commonWords = ['history', 'geography', 'civics', 'government', 'constitution', 'independence', 'mughal', 'british'];
                const interests = commonWords.filter(word => allQuestions.includes(word));
                if (interests.length > 0) {
                    studentProfile += `- Shows interest in: ${interests.join(', ')}\n`;
                }
            }
        }
        
        // Create comprehensive system prompt with learning
        const systemPrompt = `You are a helpful and friendly AI Tutor for ${studentName}, a Class 8 student in India studying Social Science. 

${studentProfile}

Based on this information about ${studentName}, personalize your teaching approach:
- Address them by name frequently
- Reference their previous questions when relevant
- Acknowledge their strengths and gently help with weaker areas
- Build on topics they've shown interest in
- Adapt your explanation style based on their learning patterns
- Be encouraging about their progress over time

Keep responses conversational, engaging, and educational. If questions are outside SST scope, politely answer it while using their name but then redirect them to tell they have to do SST right now.`;

        // Build contextual prompt
        let contextualPrompt;
        if (conversationSummary) {
            contextualPrompt = `${conversationSummary}\n\n${studentName}'s current question: ${userInput}\n\nBased on our conversation history and ${studentName}'s learning profile, please provide a personalized response.`;
        } else {
            contextualPrompt = `${studentName} asks: ${userInput}`;
        }
            
        const aiResponse = await callGemini(contextualPrompt, systemPrompt);

        await supabaseClient.from('ai_chat_messages').insert({ chat_id: activeChatId, role: 'model', content: aiResponse });

        messagesContainer.innerHTML += `<div class="message-bubble model">${aiResponse.replace(/\n/g, '<br>')}</div>`;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

    } catch (error) {
        showFeedback('Error communicating with AI Assistant.', 'error');
        console.error(error);
    }
}
// Replace the existing handleChatMessageSubmit function with this curriculum-aware version

async function handleChatMessageSubmit(e) {
    e.preventDefault();
    const input = document.getElementById('chat-input');
    const userInput = input.value.trim();
    if(!userInput) return;

    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.innerHTML += `<div class="message-bubble user">${userInput}</div>`;
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    input.value = '';
    
    const studentName = currentUser.username;

    try {
        if (!activeChatId) {
            const title = userInput.substring(0, 30) + (userInput.length > 30 ? '...' : '');
            const { data, error } = await supabaseClient.from('ai_chats').insert({ user_id: currentUser.id, title: title }).select().single();
            if(error) throw error;
            activeChatId = data.id;
            await loadChatHistory();
            document.querySelector(`.chat-history-item[data-chat-id="${activeChatId}"]`).classList.add('active');
        }

        await supabaseClient.from('ai_chat_messages').insert({ chat_id: activeChatId, role: 'user', content: userInput });
        
        // Fetch ALL platform data for comprehensive AI knowledge
        const [allStudentMessages, studentPerformance, allTopics, sampleQuestions] = await Promise.all([
            // Student's conversation history
            supabaseClient
                .from('ai_chat_messages')
                .select('role, content, created_at, ai_chats!inner(user_id)')
                .eq('ai_chats.user_id', currentUser.id)
                .order('created_at', { ascending: true }),
            
            // Student's quiz performance
            supabaseClient
                .from('attempts')
                .select('score, questions(topics(name, subject))')
                .eq('user_id', currentUser.id),
                
            // All topics available on platform
            supabaseClient
                .from('topics')
                .select('*')
                .order('subject', { ascending: true }),
                
            // Sample questions from each topic for context
            supabaseClient
                .from('questions')
                .select('question_text, topics(name, subject)')
                .limit(50)
        ]);
        
        // Build comprehensive platform curriculum knowledge
        let curriculumContext = `Platform Curriculum Overview:\n`;
        
        if (allTopics.data && allTopics.data.length > 0) {
            const topicsBySubject = allTopics.data.reduce((acc, topic) => {
                if (!acc[topic.subject]) acc[topic.subject] = [];
                acc[topic.subject].push(topic.name);
                return acc;
            }, {});
            
            Object.entries(topicsBySubject).forEach(([subject, topics]) => {
                curriculumContext += `\n${subject} Topics:\n`;
                topics.forEach(topic => {
                    const isActive = allTopics.data.find(t => t.name === topic)?.active_status;
                    curriculumContext += `- ${topic} ${isActive ? '(Active)' : '(Inactive)'}\n`;
                });
            });
        }
        
        // Add sample questions context
        if (sampleQuestions.data && sampleQuestions.data.length > 0) {
            curriculumContext += `\nSample Questions Available:\n`;
            const questionsByTopic = sampleQuestions.data.reduce((acc, q) => {
                if (q.topics) {
                    const topicName = q.topics.name;
                    if (!acc[topicName]) acc[topicName] = [];
                    acc[topicName].push(q.question_text || q.question);
                }
                return acc;
            }, {});
            
            Object.entries(questionsByTopic).forEach(([topic, questions]) => {
                curriculumContext += `${topic}: ${questions.slice(0, 2).join('; ')}\n`;
            });
        }
        
        // Build student profile
        let studentProfile = `Student Profile for ${studentName}:\n`;
        
        if (studentPerformance.data && studentPerformance.data.length > 0) {
            const totalQuestions = studentPerformance.data.length;
            const correctAnswers = studentPerformance.data.filter(a => a.score > 0).length;
            const accuracy = ((correctAnswers / totalQuestions) * 100).toFixed(1);
            
            const subjectPerf = studentPerformance.data.reduce((acc, attempt) => {
                if (attempt.questions?.topics) {
                    const subject = attempt.questions.topics.subject;
                    if (!acc[subject]) acc[subject] = { correct: 0, total: 0 };
                    acc[subject].total++;
                    if (attempt.score > 0) acc[subject].correct++;
                }
                return acc;
            }, {});
            
            studentProfile += `- Overall quiz accuracy: ${accuracy}%\n`;
            studentProfile += `- Total questions attempted: ${totalQuestions}\n`;
            
            Object.entries(subjectPerf).forEach(([subject, data]) => {
                const subjectAccuracy = ((data.correct / data.total) * 100).toFixed(1);
                studentProfile += `- ${subject} performance: ${subjectAccuracy}% (${data.correct}/${data.total})\n`;
            });
            
            // Find topics they've studied vs available topics
            const studiedTopics = studentPerformance.data
                .filter(a => a.questions?.topics)
                .map(a => a.questions.topics.name);
            const uniqueStudiedTopics = [...new Set(studiedTopics)];
            const allAvailableTopics = allTopics.data ? allTopics.data.map(t => t.name) : [];
            const unstudiedTopics = allAvailableTopics.filter(t => !uniqueStudiedTopics.includes(t));
            
            studentProfile += `- Topics studied: ${uniqueStudiedTopics.join(', ')}\n`;
            if (unstudiedTopics.length > 0) {
                studentProfile += `- Topics not yet attempted: ${unstudiedTopics.slice(0, 5).join(', ')}${unstudiedTopics.length > 5 ? '...' : ''}\n`;
            }
        }
        
        // Build conversation history
        let conversationSummary = '';
        if (allStudentMessages.data && allStudentMessages.data.length > 0) {
            const recentMessages = allStudentMessages.data.slice(-20);
            conversationSummary = `Recent conversation history with ${studentName}:\n`;
            
            recentMessages.forEach(msg => {
                const speaker = msg.role === 'user' ? studentName : 'Tutor';
                conversationSummary += `${speaker}: ${msg.content}\n`;
            });
            
            const userMessages = allStudentMessages.data.filter(m => m.role === 'user');
            if (userMessages.length > 5) {
                studentProfile += `- Total questions asked in chat: ${userMessages.length}\n`;
            }
        }
        
        // Create comprehensive system prompt
        const systemPrompt = `You are ${studentName}'s personal AI Tutor for Class 8 Social Science in India. You have complete knowledge of the learning platform and curriculum.

${curriculumContext}

${studentProfile}

Teaching Instructions:
- Address ${studentName} by name and reference their learning journey
- Connect questions to specific topics available on the platform
- Suggest related topics they might find interesting based on platform curriculum  
- Reference their quiz performance when relevant
- Recommend topics they haven't studied yet when appropriate
- Use examples from questions available on the platform
- If they ask about topics not on the platform, explain what IS available instead
- Build on their conversation history and learning patterns
- Be encouraging about their progress and suggest next steps
-If they ask something else from SST answer it politeley to and personalized to ${studentName}'s learning profile but then redirect them to SST
-Use emojis in your answers
-If a child asks who made you say Akshaj Created me with brilliance
-If a  child writes speacial code which is 989 become normal chatting assistant with them
-If the child again writes 989 become the SST tutor again

Keep responses educational, engaging, and personalized to ${studentName}'s learning profile.`;

        // Build contextual prompt
        let contextualPrompt;
        if (conversationSummary) {
            contextualPrompt = `${conversationSummary}\n\n${studentName}'s current question: ${userInput}\n\nBased on our platform curriculum, conversation history, and ${studentName}'s learning profile, provide a comprehensive and personalized response.`;
        } else {
            contextualPrompt = `${studentName} asks: ${userInput}`;
        }
            
        const aiResponse = await callGemini(contextualPrompt, systemPrompt);

        await supabaseClient.from('ai_chat_messages').insert({ chat_id: activeChatId, role: 'model', content: aiResponse });

        messagesContainer.innerHTML += `<div class="message-bubble model">${aiResponse.replace(/\n/g, '<br>')}</div>`;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

    } catch (error) {
        showFeedback('Error communicating with AI Assistant.', 'error');
        console.error(error);
    }
}// Add this code at the end of your JavaScript to fix the double question count issue--------------------------------------------------------------------------------------------------------------------------------------

// Override initializeQuiz to ensure attempts array is properly reset
async function initializeQuiz(questions, quizTitle) {
    document.getElementById('quiz-topic-name').textContent = quizTitle;
    document.getElementById('quiz-modal').classList.remove('hidden');
    document.getElementById('quiz-result').classList.add('hidden');
    document.getElementById('quiz-body').classList.remove('hidden');
    document.getElementById('quiz-footer').style.display = 'flex';
    document.getElementById('quiz-progress-bar').style.width = '0%';

    const shuffledQuestions = questions.sort(() => 0.5 - Math.random());
    quizState = {
        id: Date.now(),
        questions: shuffledQuestions.slice(0, 30),
        currentQuestionIndex: 0,
        score: 0,
        attempts: [], // Ensure attempts array is always reset
        lastAnswered: null
    };
    
    renderQuestion();
    startTimer(15 * 60);
    quizLoading = false;
}

// Override selectOption to prevent double submissions
function selectOption(selectedBtn) {
    // Prevent double clicks and multiple submissions
    if (selectedBtn.classList.contains('disabled') || document.querySelectorAll('.option-btn.disabled').length > 0) {
        return;
    }
    
    const selectedOption = selectedBtn.dataset.option;
    quizState.lastAnswered = selectedOption;
    const question = quizState.questions[quizState.currentQuestionIndex];
    const isCorrect = selectedOption === question.correct_answer;
    let score = 0;
    
    if (isCorrect) { 
        quizState.score += 2; // 1 point per correct answer
        score = 2; 
        selectedBtn.classList.add('correct'); 
    } else { 
        selectedBtn.classList.add('incorrect'); 
        document.querySelector(`.option-btn[data-option="${question.correct_answer}"]`)?.classList.add('correct'); 
    }
    
    // Add to attempts array - this should only happen once per question
    quizState.attempts.push({ 
        user_id: currentUser.id, 
        question_id: question.id, 
        selected_option: selectedOption, 
        score: score 
    });
    
    // Disable all buttons to prevent multiple clicks
    document.querySelectorAll('.option-btn').forEach(btn => btn.classList.add('disabled'));
    document.getElementById('explanation-container').classList.remove('hidden');
    document.getElementById('explain-answer-btn').disabled = false;
    document.getElementById('next-question-btn').classList.remove('hidden');
}

// Override endQuiz to ensure attempts are only inserted once
async function endQuiz() {
    clearInterval(currentTimer);
    document.getElementById('quiz-progress-bar').style.width = `100%`;
    
    // Check if we have attempts and haven't already saved them
    if(quizState.attempts && quizState.attempts.length > 0 && !quizState.attemptsSaved) {
        const { error: attemptsError } = await supabaseClient.from('attempts').insert(quizState.attempts);
        if (attemptsError) { 
            showFeedback('Error saving quiz results.', 'error');
            console.error('Attempts save error:', attemptsError);
        } else {
            quizState.attemptsSaved = true; // Mark as saved to prevent double saving
        }
    }

    const { data: performanceData, error: fetchError } = await supabaseClient
        .from('student_performance')
        .select('total_score')
        .eq('user_id', currentUser.id)
        .single();

    if (fetchError) {
        showFeedback('Error fetching current score.', 'error');
    } else {
        const newTotalScore = performanceData.total_score + quizState.score;
        const { error: updateError } = await supabaseClient
            .from('student_performance')
            .update({ total_score: newTotalScore })
            .eq('user_id', currentUser.id);

        if (updateError) {
            showFeedback('Error updating total score.', 'error');
        } else {
            await checkAndAwardBadges();
            await updateStudentPointsDisplay();
        }
    }

    document.getElementById('quiz-body').classList.add('hidden');
    document.getElementById('quiz-footer').style.display = 'none';
    const resultContainer = document.getElementById('quiz-result');
    resultContainer.classList.remove('hidden');
    resultContainer.innerHTML = `<h2>Quiz Complete!</h2><p>You scored ${quizState.score} out of ${quizState.questions.length} points</p><button id="finish-quiz-btn" class="btn btn-primary">Finish</button>`;
}

// Clear quiz state when closing modal to prevent carryover
document.getElementById('close-quiz-btn').addEventListener('click', function() {
    quizState = {};
    clearInterval(currentTimer);
    quizLoading = false;
});

document.addEventListener('click', function(e) {
    if (e.target.id === 'finish-quiz-btn') {
        quizState = {}; // Clear state completely
        clearInterval(currentTimer);
        quizLoading = false;
    }
})// Override endQuiz to give quiz score + 20 completion bonus
async function endQuiz() {
    clearInterval(currentTimer);
    document.getElementById('quiz-progress-bar').style.width = `100%`;
    
    // Check if we have attempts and haven't already saved them
    if(quizState.attempts && quizState.attempts.length > 0 && !quizState.attemptsSaved) {
        const { error: attemptsError } = await supabaseClient.from('attempts').insert(quizState.attempts);
        if (attemptsError) { 
            showFeedback('Error saving quiz results.', 'error');
            console.error('Attempts save error:', attemptsError);
        } else {
            quizState.attemptsSaved = true; // Mark as saved to prevent double saving
        }
    }

    const { data: performanceData, error: fetchError } = await supabaseClient
        .from('student_performance')
        .select('total_score')
        .eq('user_id', currentUser.id)
        .single();

    if (fetchError) {
        showFeedback('Error fetching current score.', 'error');
    } else {
        const completionBonus = 20; // 20 points for completing any quiz
        const totalEarned = quizState.score + completionBonus; // Quiz score + completion bonus
        const newTotalScore = performanceData.total_score + totalEarned;
        
        const { error: updateError } = await supabaseClient
            .from('student_performance')
            .update({ total_score: newTotalScore })
            .eq('user_id', currentUser.id);

        if (updateError) {
            showFeedback('Error updating total score.', 'error');
        } else {
            await checkAndAwardBadges();
            await updateStudentPointsDisplay();
        }
    }

    document.getElementById('quiz-body').classList.add('hidden');
    document.getElementById('quiz-footer').style.display = 'none';
    const resultContainer = document.getElementById('quiz-result');
    resultContainer.classList.remove('hidden');
    
    // Show breakdown of points earned
    const completionBonus = 20;
    const totalEarned = quizState.score + completionBonus;
    resultContainer.innerHTML = `
        <h2>Quiz Complete!</h2>
        <p>You scored ${quizState.score} out of ${quizState.questions.length * 2} points</p>
        <p style="color: var(--secondary-color); font-weight: 600;">+ ${completionBonus} bonus points for completing the quiz!</p>
        <p style="font-size: 1.25rem; font-weight: 700; color: var(--primary-color);">Total Points Earned: ${totalEarned}</p>
        <button id="finish-quiz-btn" class="btn btn-primary">Finish</button>
    `;
}// Override handleExplainAnswer to show loader when explaining answers
async function handleExplainAnswer() {
    const btn = document.getElementById('explain-answer-btn');
    const contentEl = document.getElementById('explanation-content');
    
    // Disable button and show loading state
    btn.disabled = true;
    btn.textContent = 'Loading...';
    contentEl.innerHTML = '<div class="loader"></div>';

    const question = quizState.questions[quizState.currentQuestionIndex];
    const userAnswer = quizState.lastAnswered;
    
    try {
        const prompt = `Act as a helpful Social Science tutor for a Class 8 student. The student was asked: "${question.question_text || question.question}". The options were A) ${question.option_a}, B) ${question.option_b}, C) ${question.option_c}, D) ${question.option_d}. The correct answer is ${question.correct_answer}. The student chose ${userAnswer}. Please provide a simple explanation in one or two short paragraphs. First, explain why the correct answer is right. Then, if the student's answer was wrong, briefly explain why their choice was incorrect.`;
        
        const explanationText = await callGemini(prompt);
        contentEl.innerHTML = `<p>${explanationText}</p>`;
        
    } catch (error) {
        contentEl.innerHTML = `<p>Could not generate an explanation at this time.</p>`;
        console.error("AI Explanation Error:", error);
    } finally {
        // Reset button state
        btn.textContent = 'Explain Answer';
        btn.disabled = false;
    }
}// Override the message display to support markdown formatting
(function() {
    const originalInnerHTML = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML');
    
    Object.defineProperty(Element.prototype, 'innerHTML', {
        set: function(value) {
            if (this.classList && this.classList.contains('message-bubble') && this.classList.contains('model')) {
                const formattedValue = value
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');
                originalInnerHTML.set.call(this, formattedValue);
            } else {
                originalInnerHTML.set.call(this, value);
            }
        },
        get: originalInnerHTML.get
    });
})()// Intercept AI responses and format markdown
const originalCallGemini = callGemini;
callGemini = async function(userQuery, systemPrompt = null) {
    const response = await originalCallGemini(userQuery, systemPrompt);
    return response
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>');

}
// Complete code for AI question generation and 2-attempt limit
// Create this table first in Supabase:
// CREATE TABLE student_topic_attempts (
//     id SERIAL PRIMARY KEY,
//     user_id INTEGER REFERENCES users(id),
//     topic_id INTEGER REFERENCES topics(id),
//     attempt_count INTEGER DEFAULT 0,
//     created_at TIMESTAMP DEFAULT NOW(),
//     UNIQUE(user_id, topic_id)
// );

// Track topic attempts and limit points
async function checkTopicAttempts(topicId, userId) {
    try {
        const { data: attempts, error } = await supabaseClient
            .from('student_topic_attempts')
            .select('attempt_count')
            .eq('user_id', userId)
            .eq('topic_id', topicId)
            .single();

        if (error && error.code !== 'PGRST116') {
            return { shouldAwardPoints: true, attemptCount: 1 };
        }

        if (!attempts) {
            await supabaseClient
                .from('student_topic_attempts')
                .insert({ user_id: userId, topic_id: topicId, attempt_count: 1 });
            return { shouldAwardPoints: true, attemptCount: 1 };
        } else {
            const newCount = attempts.attempt_count + 1;
            await supabaseClient
                .from('student_topic_attempts')
                .update({ attempt_count: newCount })
                .eq('user_id', userId)
                .eq('topic_id', topicId);

            return { 
                shouldAwardPoints: newCount <= 2, 
                attemptCount: newCount 
            };
        }
    } catch (error) {
        return { shouldAwardPoints: true, attemptCount: 1 };
    }
}

// Override startQuiz to store topic ID
async function startQuiz(topicId, topicName) {
    if (quizLoading) return;
    quizLoading = true;
    
    const quizId = Date.now();
    quizState.id = quizId;
    quizState.topicId = topicId;

    document.getElementById('question-text').textContent = 'Loading questions...';
    document.getElementById('options-container').innerHTML = '<div class="loader"></div>';

    const { data, error } = await supabaseClient.from('questions').select('*').eq('topic_id', topicId);
    
    if (quizState.id !== quizId) return;

    if (error || data.length === 0) {
        showFeedback('Could not load questions for this topic.', 'error');
        document.getElementById('quiz-modal').classList.add('hidden'); 
        quizLoading = false;
        return;
    }
    
    initializeQuiz(data, topicName);
}

// Override endQuiz with attempt limit
async function endQuiz() {
    clearInterval(currentTimer);
    document.getElementById('quiz-progress-bar').style.width = `100%`;
    
    if(quizState.attempts && quizState.attempts.length > 0 && !quizState.attemptsSaved) {
        const { error: attemptsError } = await supabaseClient.from('attempts').insert(quizState.attempts);
        if (attemptsError) { 
            showFeedback('Error saving quiz results.', 'error');
        } else {
            quizState.attemptsSaved = true;
        }
    }

    const { data: performanceData, error: fetchError } = await supabaseClient
        .from('student_performance')
        .select('total_score')
        .eq('user_id', currentUser.id)
        .single();

    if (fetchError) {
        showFeedback('Error fetching current score.', 'error');
        return;
    }

    const topicId = quizState.topicId;
    const { shouldAwardPoints, attemptCount } = await checkTopicAttempts(topicId, currentUser.id);
    
    if (shouldAwardPoints) {
        const completionBonus = 20;
        const pointsAwarded = quizState.score + completionBonus;
        const newTotalScore = performanceData.total_score + pointsAwarded;
        
        const { error: updateError } = await supabaseClient
            .from('student_performance')
            .update({ total_score: newTotalScore })
            .eq('user_id', currentUser.id);

        if (!updateError) {
            await checkAndAwardBadges();
            await updateStudentPointsDisplay();
        }
    }

    document.getElementById('quiz-body').classList.add('hidden');
    document.getElementById('quiz-footer').style.display = 'none';
    const resultContainer = document.getElementById('quiz-result');
    resultContainer.classList.remove('hidden');
    
    let resultHTML;
    if (shouldAwardPoints) {
        const completionBonus = 20;
        const totalEarned = quizState.score + completionBonus;
        resultHTML = `
            <h2>Quiz Complete!</h2>
            <p>You scored ${quizState.score} out of ${quizState.questions.length * 2} points</p>
            <p style="color: var(--secondary-color); font-weight: 600;">+ ${completionBonus} bonus points for completing the quiz!</p>
            <p style="font-size: 1.25rem; font-weight: 700; color: var(--primary-color);">Total Points Earned: ${totalEarned}</p>
            <p style="color: var(--muted-text-color); font-size: 0.875rem;">Attempt ${attemptCount}/2 for this topic</p>
            <button id="finish-quiz-btn" class="btn btn-primary">Finish</button>
        `;
    } else {
        resultHTML = `
            <h2>Quiz Complete!</h2>
            <p>You scored ${quizState.score} out of ${quizState.questions.length * 2} points</p>
            <p style="color: var(--warning-color); font-weight: 600;">No points awarded - This is attempt ${attemptCount} for this topic</p>
            <p style="color: var(--muted-text-color);">Points are only awarded for the first 2 attempts per topic.</p>
            <button id="finish-quiz-btn" class="btn btn-primary">Finish</button>
        `;
    }
    
    resultContainer.innerHTML = resultHTML;
}

// Fixed AI question generation
async function handleAiGenerationFormSubmit(e) {
    e.preventDefault();
    const numQuestions = document.getElementById('ai-num-questions').value;
    const topicName = document.getElementById('ai-assistant-modal').dataset.topicName;
    const resultsContainer = document.getElementById('ai-results-container');
    resultsContainer.innerHTML = '<div class="loader"></div><p>Generating questions... Please wait.</p>';
    const extraPrompt = document.getElementById('ai-extra-prompt').value.trim();

    try {
        const apiKey = await getGeminiApiKey();
        let userQuery = `Generate exactly ${numQuestions} multiple-choice questions for Class 8 Social Science on "${topicName}".

Return ONLY valid JSON array:
[
    {
        "question_text": "Question here?",
        "option_a": "Option A",
        "option_b": "Option B", 
        "option_c": "Option C",
        "option_d": "Option D",
        "correct_answer": "A"
    }
]

Requirements:
- Age-appropriate for Class 8 students
- correct_answer must be exactly "A", "B", "C", or "D"
- No explanations, just the JSON array`;

        if (extraPrompt) {
            userQuery += `\n\nExtra: ${extraPrompt}`;
        }

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: userQuery }] }],
                generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
            })
        });

        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        
        const result = await response.json();
        let jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (!jsonText) throw new Error("No response from AI");

        jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        
        const jsonStart = jsonText.indexOf('[');
        const jsonEnd = jsonText.lastIndexOf(']') + 1;
        
        if (jsonStart === -1 || jsonEnd === 0) {
            throw new Error("Invalid JSON format");
        }
        
        const cleanJson = jsonText.substring(jsonStart, jsonEnd);
        const generatedQuestions = JSON.parse(cleanJson);
        
        if (!Array.isArray(generatedQuestions) || generatedQuestions.length === 0) {
            throw new Error("No valid questions generated");
        }

        const validQuestions = generatedQuestions.filter(q => 
            q.question_text && q.option_a && q.option_b && q.option_c && q.option_d && 
            ['A', 'B', 'C', 'D'].includes(q.correct_answer)
        );

        if (validQuestions.length === 0) {
            throw new Error("Generated questions are invalid");
        }

        renderAiGeneratedQuestions(validQuestions);
        
    } catch (error) {
        console.error('AI Error:', error);
        resultsContainer.innerHTML = `
            <p style="color: var(--error-color);">Failed to generate questions. Please try again.</p>
            <button class="btn btn-secondary" onclick="handleAiGenerationFormSubmit(event)" style="width: auto; margin-top: 1rem;">Retry</button>
        `;
    }
}

// Fixed renderAiGeneratedQuestions
function renderAiGeneratedQuestions(questions) {
    const resultsContainer = document.getElementById('ai-results-container');
    if (!questions || questions.length === 0) {
        resultsContainer.innerHTML = `<p>No questions generated. Please try again.</p>`;
        return;
    }
    
    let html = '';
    questions.forEach((q, index) => {
        const questionData = JSON.stringify(q).replace(/"/g, '&quot;');
        html += `
            <div class="ai-generated-question">
                <h4>${index + 1}. ${q.question_text}</h4>
                <ul>
                    <li>A: ${q.option_a}</li>
                    <li>B: ${q.option_b}</li>
                    <li>C: ${q.option_c}</li>
                    <li>D: ${q.option_d}</li>
                </ul>
                <p>Correct Answer: <span class="correct-answer">${q.correct_answer}</span></p>
                <button class="btn btn-secondary btn-add-ai-q" data-question='${questionData}'>Add to Topic</button>
            </div>
        `;
    });
    resultsContainer.innerHTML = html;
}

// Fixed handleAddAiQuestion
async function handleAddAiQuestion(button) {
    const topicId = document.getElementById('ai-assistant-modal').dataset.topicId;
    const questionData = JSON.parse(button.dataset.question);
    
    if (!questionData.question_text || !questionData.option_a || !questionData.correct_answer) {
        showFeedback('Invalid question data', 'error');
        return;
    }

    const payload = {
        topic_id: topicId,
        question_text: questionData.question_text,
        option_a: questionData.option_a,
        option_b: questionData.option_b,
        option_c: questionData.option_c,
        option_d: questionData.option_d,
        correct_answer: questionData.correct_answer
    };

    const { error } = await supabaseClient.from('questions').insert(payload);
    
    if (error) {
        showFeedback('Error adding question', 'error');
    } else {
        showFeedback('Question added successfully!', 'success');
        button.textContent = 'Added!';
        button.disabled = true;
        button.style.backgroundColor = 'var(--secondary-color)';
    }
}

// Event listener for AI question buttons
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('btn-add-ai-q')) {
        handleAddAiQuestion(e.target);
    }
});
        
</script>

</body>
</html>

